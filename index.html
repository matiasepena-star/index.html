<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Martu-art ¬∑ Expos + Dibujos</title>

  <style>
    :root{
      --bg:#0f1115;
      --panel: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text:#e8ecf6;
      --muted: rgba(232,236,246,.62);
      --brand:#7aa2ff;
      --good:#44d07b;
      --bad:#ff5b6b;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --r: 22px;
      --press: translateY(1px) scale(.99);
      --press2: translateY(2px) scale(.985);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 650px at 20% -10%, rgba(122,162,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(68,208,123,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 76px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{
      display:flex;gap:14px;align-items:center;
      padding:18px;
      border-bottom:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
    }
    .pill{
      width:54px;height:54px;border-radius:18px;
      background: linear-gradient(180deg, rgba(122,162,255,.55), rgba(122,162,255,.18));
      border:1px solid rgba(122,162,255,.35);
      box-shadow: 0 14px 35px rgba(0,0,0,.55);
      flex:0 0 auto;
    }
    h1{margin:0;font-size:36px;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-weight:550}
    .status{
      margin-left:auto;
      display:flex;align-items:center;gap:10px;
      background: rgba(0,0,0,.18);
      border:1px solid var(--stroke);
      border-radius: 999px;
      padding:10px 12px;
      min-width: 160px;
      justify-content: space-between;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(255,91,107,.15);
    }
    .dot.good{background: var(--good); box-shadow: 0 0 0 4px rgba(68,208,123,.15)}
    .stText{font-weight:750}
    .stSub{color:var(--muted);font-size:12px;margin-top:2px}

    /* Tabs */
    .tabs{
      padding:14px 18px 0;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    .tab{
      display:flex;align-items:center;justify-content:center;
      gap:10px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      padding:14px 12px;
      font-weight:800;
      user-select:none;
      -webkit-user-select:none;
      cursor:pointer;
      transition: transform .08s ease, filter .12s ease, background .12s ease, border-color .12s ease;
    }
    .tab.active{
      background: rgba(122,162,255,.16);
      border-color: rgba(122,162,255,.35);
    }

    /* Buttons (PRESS FEEL) */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:10px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      padding:14px 16px;
      color: var(--text);
      font-weight:850;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      transition: transform .08s ease, filter .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .btn.primary{
      background: rgba(122,162,255,.17);
      border-color: rgba(122,162,255,.35);
    }
    .btn:active,
    .tab:active{
      transform: var(--press);
      filter: brightness(1.05);
      box-shadow: 0 6px 14px rgba(0,0,0,.35);
    }
    .pressed{ /* para iOS (pointerdown) */
      transform: var(--press2) !important;
      filter: brightness(1.06);
      box-shadow: 0 5px 12px rgba(0,0,0,.35) !important;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
    }

    /* Layout */
    .body{padding:18px}
    .muted{color:var(--muted)}
    .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .field label{
      display:block;
      color:var(--muted);
      font-weight:700;
      margin:12px 0 8px;
    }
    .inp, select, input[type="file"]{
      width:100%;
      background: rgba(0,0,0,.20);
      border:1px solid var(--stroke);
      color: var(--text);
      border-radius: 18px;
      padding:14px 14px;
      outline:none;
      font-size:16px;
    }
    select{appearance:none}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .hr{height:1px;background:var(--stroke);margin:16px 0}

    /* Gallery */
    .gallery{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      margin-top:14px;
    }
    @media (min-width: 820px){
      .gallery{grid-template-columns: repeat(3, minmax(0, 1fr))}
    }
    .tile{
      position:relative;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      min-height: 160px;
      cursor:pointer;
      user-select:none;-webkit-user-select:none;
      transition: transform .08s ease, filter .12s ease;
    }
    .tile:active{transform: var(--press)}
    .tile img{
      width:100%;
      height:240px;
      object-fit: cover;
      display:block;
      background: rgba(0,0,0,.25);
    }
    .tag{
      position:absolute;left:10px;top:10px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.88);
      padding:7px 10px;
      border-radius: 999px;
      font-weight:850;
      font-size:14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      max-width: calc(100% - 20px);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .tileMeta{
      padding:10px 12px;
      color: var(--muted);
      font-size:12px;
      display:flex;justify-content:space-between;gap:10px;
    }
    .tileMeta b{color: rgba(232,236,246,.80);font-weight:850}

    /* Modal */
    .modal{
      position:fixed;inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal.show{display:flex}
    .modalBox{
      width:min(980px, 100%);
      background: rgba(18,20,26,.86);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      overflow:hidden;
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
    }
    .modalTop{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalTop .note{
      color: rgba(232,236,246,.70);
      font-weight:800;
      display:flex;align-items:center;gap:10px;
    }
    .xbtn{
      width:42px;height:42px;border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size:18px;
      cursor:pointer;
      user-select:none;-webkit-user-select:none;
      transition: transform .08s ease;
    }
    .xbtn:active{transform: var(--press)}
    .modalImg{
      width:100%;
      height:min(72vh, 760px);
      object-fit: contain;
      background: rgba(0,0,0,.35);
      display:block;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding:12px 14px;
      border-radius: 999px;
      box-shadow: 0 18px 55px rgba(0,0,0,.65);
      display:flex;align-items:center;gap:10px;
      max-width:min(94vw, 720px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:60;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .toast.show{opacity:1; pointer-events:auto; transform: translateX(-50%) translateY(-2px)}
    .toast .msg{font-weight:800}
    .toast .close{
      margin-left:8px;
      width:34px;height:34px;border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      transition: transform .08s ease;
    }
    .toast .close:active{transform: var(--press)}
    .footer{
      padding:10px 18px;
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
      border-top:1px solid var(--stroke);
      color: var(--muted);
      background: rgba(0,0,0,.18);
      font-weight:700;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .small{font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="pill"></div>
        <div>
          <h1>Martu-art</h1>
          <div class="sub">Expos + Dibujos (GitHub Pages + Supabase Storage)</div>
        </div>

        <div class="status">
          <div style="display:flex;align-items:center;gap:10px">
            <div id="dot" class="dot"></div>
            <div>
              <div id="stTitle" class="stText">Conectando‚Ä¶</div>
              <div id="stSub" class="stSub">probando Storage</div>
            </div>
          </div>
          <div style="font-size:18px" id="stIcon">‚è≥</div>
        </div>
      </div>

      <div class="tabs">
        <div id="tabExpos" class="tab active">üìÅ Expos</div>
        <div id="tabUpload" class="tab">‚¨ÜÔ∏è Subir dibujo</div>
        <div id="tabGallery" class="tab">üñºÔ∏è Galer√≠a</div>
      </div>

      <div class="body">
        <div class="muted" style="font-weight:700">
          Esto usa solo <b>Storage</b> (sin DB y sin librer√≠as externas). Menos magia, m√°s funciona.
        </div>

        <!-- Panel: Expos -->
        <div id="panelExpos" style="margin-top:14px">
          <div class="field">
            <label>Nombre de la expo</label>
            <input id="expoName" class="inp" placeholder="Ej: Primavera 2026, Dinosaurios, etc.">
            <div class="hint">El slug se autogenera (para usarlo como carpeta en Storage).</div>
          </div>

          <div class="field">
            <label>Slug (se autogenera)</label>
            <input id="expoSlug" class="inp mono" placeholder="ej: primavera-2026" disabled>
          </div>

          <div class="row" style="margin-top:14px">
            <button id="btnCreateExpo" class="btn primary">Crear expo</button>
            <button id="btnRefreshExpos" class="btn">Actualizar lista</button>
          </div>

          <div class="hr"></div>

          <div class="field">
            <label>Expo seleccionada</label>
            <select id="expoSelect"></select>
          </div>

          <div class="field">
            <label>Link de la expo (para compartir)</label>
            <input id="shareLink" class="inp mono" readonly placeholder="Se completa al elegir una expo">
            <div class="row" style="margin-top:10px">
              <button id="btnCopyLink" class="btn">Copiar link</button>
            </div>
          </div>
        </div>

        <!-- Panel: Upload -->
        <div id="panelUpload" style="margin-top:14px; display:none">
          <div class="muted" style="font-weight:700">Sub√≠ una foto del dibujo (jpg/png). Se guarda en el bucket y queda en la expo seleccionada.</div>

          <div class="field">
            <label>Expo</label>
            <select id="expoSelectUpload"></select>
          </div>

          <div class="field">
            <label>Archivo (foto del dibujo)</label>
            <input id="fileInput" type="file" accept="image/*">
            <div class="hint">Tip: si pesa mucho, igual va. (Tu plan free deja 50MB).</div>
          </div>

          <div class="field">
            <label>T√≠tulo (opcional)</label>
            <input id="imgTitle" class="inp" placeholder="Ej: Gatito, Arco√≠ris, etc.">
            <div class="hint">Este t√≠tulo es el que va a aparecer en la etiqueta del dibujo.</div>
          </div>

          <div class="row" style="margin-top:14px">
            <button id="btnUpload" class="btn primary">Subir</button>
            <button id="btnGoGallery" class="btn">Ver galer√≠a</button>
          </div>
        </div>

        <!-- Panel: Gallery -->
        <div id="panelGallery" style="margin-top:14px; display:none">
          <div class="muted" style="font-weight:700">Eleg√≠ una expo y te muestro los dibujos subidos.</div>

          <div class="field">
            <label>Expo</label>
            <select id="expoSelectGallery"></select>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="btnLoadGallery" class="btn primary">Cargar galer√≠a</button>
            <button id="btnGoUpload" class="btn">Subir otro</button>
          </div>

          <div id="gallery" class="gallery"></div>
        </div>
      </div>

      <div class="footer">
        <div>Estado: <b id="footState" class="mono">‚Äî</b></div>
        <div>bucket: <b id="footBucket" class="mono">‚Äî</b></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modalBox">
      <div class="modalTop">
        <div class="note">üëà Toc√° para agrandar</div>
        <button id="modalClose" class="xbtn">‚úï</button>
      </div>
      <img id="modalImg" class="modalImg" alt="">
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <div id="toastMsg" class="msg">‚Äî</div>
    <button id="toastX" class="close">‚úï</button>
  </div>

  <script>
  /* =========================================================
     1) CONFIG (TOC√Å SOLO ESTO)
  ========================================================= */
  const SUPABASE_URL = "https://vfvbssenzfbrnkydddxo.supabase.co";
  const SUPABASE_KEY = "sb_publishable__3wLx8HB6dbL49gWL9Eyfw_kJPFh6kS";
  const BUCKET = "drawings";

  /* =========================================================
     2) UI helpers
  ========================================================= */
  const $ = (id)=>document.getElementById(id);

  function toast(msg, bad=false){
    $("toastMsg").textContent = msg;
    $("toastMsg").style.color = bad ? "var(--bad)" : "var(--text)";
    $("toast").classList.add("show");
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=> $("toast").classList.remove("show"), 2600);
  }
  $("toastX").onclick = ()=> $("toast").classList.remove("show");

  function setStatus(ok, title, sub=""){
    $("dot").className = "dot " + (ok ? "good" : "");
    $("stTitle").textContent = title;
    $("stSub").textContent = sub;
    $("stIcon").textContent = ok ? "‚úÖ" : "‚õîÔ∏è";
    $("footState").textContent = ok ? "ok" : "error";
    $("footBucket").textContent = BUCKET;
  }

  function slugify(s){
    return (s||"")
      .trim().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/^-+|-+$/g,"")
      .slice(0,60);
  }

  function encodePath(path){
    return (path||"").split("/").map(encodeURIComponent).join("/");
  }

  function publicUrl(path){
    // URL p√∫blica REAL (la que te abre el navegador)
    return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${encodePath(path)}`;
  }

  function prettyTitleFromFilename(filename){
    // filename: "arbol-2026-02-26T...-image.jpg" -> "arbol"
    const name = (filename||"").split("/").pop() || "";
    const base = name.replace(/\.[^/.]+$/,""); // sin extensi√≥n
    const cut = base.split("-202").shift();    // corta el timestamp ISO (202x)
    const t = (cut || base).replace(/-image$/i,"").replaceAll("-", " ").trim();
    return t;
  }

  function expoShareLink(slug){
    const u = new URL(location.href);
    u.searchParams.set("expo", slug);
    return u.toString();
  }

  function pressifyAll(){
    // Hace que en iPhone se "sienta" apretado SIEMPRE
    const pressables = document.querySelectorAll(".btn, .tab, .tile, .xbtn");
    pressables.forEach(el=>{
      el.addEventListener("pointerdown", ()=> el.classList.add("pressed"), {passive:true});
      const off = ()=> el.classList.remove("pressed");
      el.addEventListener("pointerup", off, {passive:true});
      el.addEventListener("pointercancel", off, {passive:true});
      el.addEventListener("pointerleave", off, {passive:true});
    });
  }

  /* =========================================================
     3) Supabase Storage REST (sin librer√≠as)
  ========================================================= */
  const API = `${SUPABASE_URL}/storage/v1`;

  async function sbFetch(path, opts={}){
    const headers = new Headers(opts.headers || {});
    headers.set("apikey", SUPABASE_KEY);
    headers.set("Authorization", `Bearer ${SUPABASE_KEY}`);
    if(!(opts.body instanceof Blob) && typeof opts.body === "string"){
      // ok
    }
    return fetch(`${API}${path}`, { ...opts, headers });
  }

  async function listAllObjects(prefix=""){
    // Lista objetos del bucket (hasta 1000). Para este uso alcanza.
    const res = await sbFetch(`/object/list/${BUCKET}`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        prefix,
        limit: 1000,
        offset: 0,
        sortBy: { column: "name", order: "asc" }
      })
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || "No pude listar objetos");
    }
    return res.json();
  }

  async function ensureExpoFolder(slug){
    // Crea un ".keep" para que exista la carpeta aunque est√© vac√≠a
    const blob = new Blob(["keep"], {type:"text/plain"});
    const path = `${slug}/.keep`;
    const res = await sbFetch(`/object/${BUCKET}/${encodePath(path)}`, {
      method:"POST",
      headers: {
        "x-upsert":"true",
        "Content-Type":"text/plain"
      },
      body: blob
    });
    if(!res.ok){
      const txt = await res.text();
      if(txt.includes("row-level security")) throw new Error("RLS: no ten√©s permiso para escribir en Storage");
      throw new Error(txt || "No pude crear la expo");
    }
    return true;
  }

  async function uploadImage(slug, file, title=""){
    const stamp = new Date().toISOString().replaceAll(":","-");
    const safeTitle = slugify(title) || "dibujo";
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const filename = `${safeTitle}-${stamp}-image.${ext}`;
    const path = `${slug}/${filename}`;

    const res = await sbFetch(`/object/${BUCKET}/${encodePath(path)}`, {
      method:"POST",
      headers: {
        "x-upsert":"true",
        "Content-Type": file.type || "application/octet-stream"
      },
      body: file
    });

    const txt = await res.text();
    if(!res.ok){
      if(txt.includes("row-level security")) throw new Error("RLS: no ten√©s permiso para subir");
      throw new Error(txt || "No subi√≥");
    }
    return { path, url: publicUrl(path) };
  }

  async function listExpos(){
    // Expos = carpetas de primer nivel (antes del '/')
    const objs = await listAllObjects("");
    const set = new Set();
    for(const o of objs){
      const name = o?.name || "";
      if(!name.includes("/")) continue;
      const folder = name.split("/")[0];
      if(folder) set.add(folder);
    }
    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  }

  async function listExpoImages(slug){
    const objs = await listAllObjects(`${slug}/`);
    const imgs = [];
    for(const o of objs){
      const name = o?.name || "";
      if(!name || name.endsWith("/.keep")) continue;
      if(!/\.(png|jpg|jpeg|webp|gif)$/i.test(name)) continue;
      imgs.push({
        path: name,
        url: publicUrl(name),
        label: prettyTitleFromFilename(name)
      });
    }
    // m√°s nuevo primero (por timestamp en el nombre)
    imgs.sort((a,b)=> b.path.localeCompare(a.path));
    return imgs;
  }

  /* =========================================================
     4) UI logic
  ========================================================= */
  function showPanel(which){
    $("tabExpos").classList.toggle("active", which==="expos");
    $("tabUpload").classList.toggle("active", which==="upload");
    $("tabGallery").classList.toggle("active", which==="gallery");

    $("panelExpos").style.display   = which==="expos" ? "" : "none";
    $("panelUpload").style.display  = which==="upload" ? "" : "none";
    $("panelGallery").style.display = which==="gallery" ? "" : "none";
  }

  $("tabExpos").onclick  = ()=>showPanel("expos");
  $("tabUpload").onclick = ()=>showPanel("upload");
  $("tabGallery").onclick= ()=>showPanel("gallery");

  $("expoName").addEventListener("input", ()=>{
    $("expoSlug").value = slugify($("expoName").value);
  });

  function fillSelect(selId, expos, keepValue){
    const sel = $(selId);
    const prev = keepValue ?? sel.value;
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî Eleg√≠ una expo ‚Äî";
    sel.appendChild(opt0);

    for(const s of expos){
      const op = document.createElement("option");
      op.value = s;
      op.textContent = `${s} (${s})`;
      sel.appendChild(op);
    }
    if(expos.includes(prev)) sel.value = prev;
  }

  function syncShareLink(){
    const slug = $("expoSelect").value;
    $("shareLink").value = slug ? expoShareLink(slug) : "";
  }
  $("expoSelect").addEventListener("change", ()=>{
    syncShareLink();
    // sincroniza los otros selects
    $("expoSelectUpload").value = $("expoSelect").value;
    $("expoSelectGallery").value = $("expoSelect").value;
  });

  $("btnCopyLink").onclick = async ()=>{
    const v = $("shareLink").value.trim();
    if(!v) return toast("Eleg√≠ una expo primero", true);
    try{
      await navigator.clipboard.writeText(v);
      toast("Link copiado ‚úÖ");
    }catch{
      toast("No pude copiar (iPhone a veces se pone exquisito). Manten√© apretado y copi√°.", true);
    }
  };

  async function refreshAllExpos(selectSlug=""){
    const expos = await listExpos();
    fillSelect("expoSelect", expos, selectSlug);
    fillSelect("expoSelectUpload", expos, selectSlug);
    fillSelect("expoSelectGallery", expos, selectSlug);
    syncShareLink();
    return expos;
  }

  $("btnRefreshExpos").onclick = async ()=>{
    try{
      $("btnRefreshExpos").disabled = true;
      await refreshAllExpos();
      toast("Lista actualizada ‚úÖ");
    }catch(e){
      toast(String(e.message||e), true);
      setStatus(false, "Error", "no pude actualizar lista");
    }finally{
      $("btnRefreshExpos").disabled = false;
    }
  };

  $("btnCreateExpo").onclick = async ()=>{
    const name = $("expoName").value.trim();
    const slug = slugify(name);
    if(!name || !slug) return toast("Pon√© un nombre de expo", true);

    try{
      $("btnCreateExpo").disabled = true;
      await ensureExpoFolder(slug);
      await refreshAllExpos(slug);
      toast("Expo creada ‚úÖ");
    }catch(e){
      toast(String(e.message||e), true);
      setStatus(false, "Error", "no pude crear expo");
    }finally{
      $("btnCreateExpo").disabled = false;
    }
  };

  $("btnUpload").onclick = async ()=>{
    const slug = $("expoSelectUpload").value;
    const file = $("fileInput").files?.[0];
    const title = $("imgTitle").value.trim();

    if(!slug) return toast("Eleg√≠ una expo", true);
    if(!file) return toast("Eleg√≠ una foto (jpg/png)", true);

    try{
      $("btnUpload").disabled = true;
      const out = await uploadImage(slug, file, title);
      toast("Subi√≥ ‚úÖ");
      // opcional: limpiar
      $("fileInput").value = "";
      $("imgTitle").value = "";
    }catch(e){
      toast(String(e.message||e), true);
      setStatus(false, "Error", "no pude subir");
    }finally{
      $("btnUpload").disabled = false;
    }
  };

  function openModal(url, alt=""){
    $("modalImg").src = url;
    $("modalImg").alt = alt;
    $("modal").classList.add("show");
  }
  function closeModal(){
    $("modal").classList.remove("show");
    $("modalImg").src = "";
  }
  $("modalClose").onclick = closeModal;
  $("modal").addEventListener("click", (e)=>{
    if(e.target === $("modal")) closeModal();
  });

  async function loadGallery(){
    const slug = $("expoSelectGallery").value;
    if(!slug) return toast("Eleg√≠ una expo", true);

    try{
      $("btnLoadGallery").disabled = true;
      const imgs = await listExpoImages(slug);
      const g = $("gallery");
      g.innerHTML = "";

      if(!imgs.length){
        g.innerHTML = `<div class="muted" style="font-weight:800; padding:12px">No hay dibujos todav√≠a en <b>${slug}</b>.</div>`;
        toast("Galer√≠a cargada ‚úÖ");
        return;
      }

      for(const it of imgs){
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.innerHTML = `
          <div class="tag">${it.label || slug}</div>
          <img src="${it.url}" alt="${it.label||""}" loading="lazy">
          <div class="tileMeta">
            <span><b>${slug}</b></span>
            <span class="mono small">${(it.path.split("/").pop()||"")}</span>
          </div>
        `;
        tile.onclick = ()=> openModal(it.url, it.label||"");
        g.appendChild(tile);
      }
      pressifyAll(); // porque agregamos tiles nuevos
      toast("Galer√≠a cargada ‚úÖ");
    }catch(e){
      toast(String(e.message||e), true);
      setStatus(false, "Error", "no pude cargar galer√≠a");
    }finally{
      $("btnLoadGallery").disabled = false;
    }
  }

  $("btnLoadGallery").onclick = loadGallery;

  $("btnGoGallery").onclick = ()=>{
    showPanel("gallery");
    $("expoSelectGallery").value = $("expoSelectUpload").value;
  };
  $("btnGoUpload").onclick = ()=>{
    showPanel("upload");
    $("expoSelectUpload").value = $("expoSelectGallery").value;
  };

  // si abr√≠s con ?expo=...
  function getExpoFromUrl(){
    try{
      const u = new URL(location.href);
      return u.searchParams.get("expo") || "";
    }catch{return ""}
  }

  /* =========================================================
     5) Boot
  ========================================================= */
  async function boot(){
    pressifyAll();

    try{
      // test simple: listar algo (si est√° vac√≠o igual responde)
      await listAllObjects("");
      setStatus(true, "Conectado", "Storage OK");
    }catch(e){
      setStatus(false, "Error", "No pude hablar con Storage");
      toast(String(e.message||e), true);
    }

    try{
      const requested = getExpoFromUrl();
      await refreshAllExpos(requested);

      if(requested){
        $("expoSelect").value = requested;
        $("expoSelectUpload").value = requested;
        $("expoSelectGallery").value = requested;
        syncShareLink();
        showPanel("gallery");
        // auto carga galer√≠a
        await loadGallery();
      }
    }catch(e){
      toast(String(e.message||e), true);
    }
  }

  boot();
  </script>
</body>
</html>