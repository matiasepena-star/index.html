<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Martu-art Â· Expos + Dibujos</title>

  <style>
    :root{
      --bg:#0f1115;
      --card:#141822;
      --stroke:rgba(255,255,255,.10);
      --text:#e8ecf6;
      --muted:rgba(232,236,246,.62);
      --brand:#7aa2ff;
      --good:#44d07b;
      --bad:#ff5b6b;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r:18px;
      --press: translateY(1.5px) scale(.985);
      --pressShadow: 0 10px 24px rgba(0,0,0,.55);
      --btnShadow: 0 14px 34px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 520px at 20% -10%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 520px at 80% 110%, rgba(68,208,123,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 84px}
    .card{
      background: rgba(20,24,34,.72);
      border:1px solid var(--stroke);
      border-radius: 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .header{
      display:flex; align-items:center; gap:12px;
      padding:16px 16px 10px;
    }
    .pill{
      width:36px;height:60px;border-radius:18px;
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.25));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    h1{font-size:40px;line-height:1;margin:0}
    .sub{color:var(--muted);margin-top:4px}

    .tabs{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      padding:12px 16px 8px;
    }

    .btn{
      appearance:none; border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 20px;
      padding: 14px 14px;
      font-weight: 800;
      cursor:pointer;
      box-shadow: var(--btnShadow);
      transition: transform .06s ease, box-shadow .12s ease;
      display:flex;align-items:center;justify-content:center;
    }
    .btn.primary{
      background: rgba(122,162,255,.14);
      border-color: rgba(122,162,255,.35);
    }
    .btn:active{
      transform: var(--press);
      box-shadow: var(--pressShadow);
    }

    .content{padding:12px 16px 16px}
    .gridGallery{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px;
      margin-top:14px;
    }

    .imgCard{
      border:1px solid var(--stroke);
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .imgCard img{
      width:100%;
      height: 220px;
      object-fit: cover;
      display:block;
    }
    .imgCard .meta{
      padding:10px 12px 12px;
      color: var(--muted);
      font-size: 12px;
      word-break: break-word;
    }
  </style>
</head>

<body>
<div class="wrap">
<div class="card">

<div class="tabs">
<button class="btn primary" id="tabUpload">Subir</button>
<button class="btn" id="tabGallery">GalerÃ­a</button>
</div>

<div class="content">

<section id="panelUpload">
<input id="expoSelectUp" placeholder="Slug expo"/>
<input id="fileInput" type="file" accept="image/*"/>
<input id="titleInput" placeholder="Nombre del dibujo"/>
<button class="btn primary" id="btnUpload">Subir</button>
</section>

<section id="panelGallery" style="display:none">
<input id="expoSelectGal" placeholder="Slug expo"/>
<button class="btn primary" id="btnLoadGallery">Cargar</button>
<div id="galleryGrid" class="gridGallery"></div>
</section>

</div>
</div>
</div>

<script>
const SUPABASE_URL = "https://vfvbssenzfbrnkydddxo.supabase.co";
const SUPABASE_KEY = "sb_publishable__3wLx8HB6dbL49gWL9Eyfw_kJPFh6kS";
const BUCKET = "drawings";

const $ = id => document.getElementById(id);
const API = `${SUPABASE_URL}/storage/v1`;

function slugify(s){
  return (s||"")
    .trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-+|-+$/g,"");
}

function publicUrl(path){
  const safe = String(path).split("/").map(encodeURIComponent).join("/");
  return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${safe}`;
}

async function sbFetch(path, opts={}){
  const headers = new Headers(opts.headers || {});
  headers.set("apikey", SUPABASE_KEY);
  headers.set("authorization", `Bearer ${SUPABASE_KEY}`);
  return fetch(`${API}${path}`, { ...opts, headers });
}

/* ðŸ”¥ CAMBIO ACÃ: nombre exacto */
async function uploadImage(slug, file, title=""){
  const ext = (file.name || "image").split(".").pop() || "jpg";
  const base = title ? slugify(title) : "dibujo";
  const filename = `${base}.${ext}`;
  const path = `${slug}/${filename}`;

  const res = await sbFetch(`/object/${BUCKET}/${path}`, {
    method: "POST",
    headers: { "x-upsert":"true", "Content-Type": file.type },
    body: file
  });

  if(!res.ok){
    const txt = await res.text();
    throw new Error(txt);
  }

  return { path, url: publicUrl(path) };
}

async function listExpoImages(slug){
  const res = await sbFetch(`/object/list/${BUCKET}`, {
    method:"POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ prefix:`${slug}/` })
  });

  const objs = await res.json();
  return objs
    .filter(o => /\.(png|jpg|jpeg|webp|gif)$/i.test(o.name))
    .map(o => ({ path:o.name, url: publicUrl(o.name) }));
}

$("btnUpload").onclick = async ()=>{
  const slug = $("expoSelectUp").value;
  const file = $("fileInput").files?.[0];
  const title = $("titleInput").value;

  if(!slug || !file) return;

  await uploadImage(slug, file, title);
  alert("Subido");
};

$("btnLoadGallery").onclick = async ()=>{
  const slug = $("expoSelectGal").value;
  const imgs = await listExpoImages(slug);

  $("galleryGrid").innerHTML = imgs.map(x=>{
    const file = x.path.split("/").pop();
    return `
      <div class="imgCard">
        <img src="${x.url}"/>
        <div class="meta">${file}</div>
      </div>
    `;
  }).join("");
};

$("tabUpload").onclick = ()=>{
  $("panelUpload").style.display="";
  $("panelGallery").style.display="none";
};

$("tabGallery").onclick = ()=>{
  $("panelUpload").style.display="none";
  $("panelGallery").style.display="";
};
</script>

</body>
</html>