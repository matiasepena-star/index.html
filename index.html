<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Galer√≠a de Dibujos</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
:root{
  --bg:#0f1115; --card:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.14);
  --text:#e8ecf6; --muted:rgba(232,236,246,.65);
  --brand:#7aa2ff; --ok:#44d07b; --bad:#ff5b6b; --r:20px;
  --tap: translateY(1px) scale(.99);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:980px;margin:0 auto;padding:14px 12px 120px}
h1{margin:0 0 6px;font-size:20px}
.p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);padding:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.rowL{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--text);
  padding:12px 14px;border-radius:16px;font-weight:900;cursor:pointer}
.btn:active{transform:var(--tap)}
.btn.primary{background:linear-gradient(135deg, rgba(122,162,255,.95), rgba(122,162,255,.65)); color:#0b0d12;border-color:rgba(0,0,0,.18)}
.btn.ok{background:linear-gradient(135deg, rgba(68,208,123,.95), rgba(68,208,123,.65)); color:#07110b;border-color:rgba(0,0,0,.18)}
.btn.bad{background:rgba(255,91,107,.16);border-color:rgba(255,91,107,.38);color:#ffd7dc}
.in{border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:var(--text);
  padding:12px 12px;border-radius:16px;font-weight:900;outline:none}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px}
@media(min-width:740px){.grid{grid-template-columns:repeat(4,minmax(0,1fr));gap:14px}}
.item{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);overflow:hidden}
.img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block;background:#0b0d12}
.meta{padding:10px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.name{font-size:12px;color:var(--muted);font-weight:900;max-width:55%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tag{font-size:12px;font-weight:1000;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22)}
.tag.on{border-color:rgba(68,208,123,.55);background:rgba(68,208,123,.14);color:#d9ffe8}
hr{border:none;border-top:1px solid rgba(255,255,255,.10);margin:12px 0}
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(18,24,40,.96);
  border:1px solid rgba(255,255,255,.14);padding:10px 12px;border-radius:14px;display:none;font-weight:950}
.toast.show{display:block}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;padding:14px;z-index:999}
.modal.open{display:flex}
.modalCard{width:min(920px,100%);max-height:92vh;overflow:hidden;display:flex;flex-direction:column;
  background:rgba(18,24,40,.96);border:1px solid rgba(255,255,255,.14);border-radius:20px}
.modalTop{display:flex;justify-content:space-between;align-items:center;padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.10);gap:10px}
.modalTop .t{font-weight:1000;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.modalBody{padding:12px;overflow:auto;-webkit-overflow-scrolling:touch}
.big{width:100%;max-height:62vh;object-fit:contain;display:block;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:#0b0d12}
.qrbox{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
canvas{border-radius:14px;background:#fff}
small{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">

  <div id="expoOnly" style="display:none">
    <div class="card">
      <div class="row">
        <div>
          <h1 id="expoTitle">Exposici√≥n</h1>
          <div class="p" id="expoSubtitle">Modo museo</div>
        </div>
        <button class="btn" id="goHome">Salir</button>
      </div>
    </div>
    <div class="grid" id="expoGrid"></div>
  </div>

  <div id="adminApp" style="display:none">
    <div class="card">
      <div class="row">
        <div>
          <h1>üé® Biblioteca + Exposici√≥n</h1>
          <div class="p">Ella guarda dibujos y marca ‚≠ê ‚ÄúExponer‚Äù. El QR abre solo la expo.</div>
        </div>
        <div class="rowL">
          <span class="tag" id="who">No logueado</span>
          <button class="btn" id="logoutBtn" style="display:none">Salir</button>
        </div>
      </div>

      <hr>

      <div id="loginBox">
        <div class="row">
          <input class="in" id="email" placeholder="Email" inputmode="email" style="flex:1;min-width:220px">
          <input class="in" id="pass" placeholder="Contrase√±a" type="password" style="flex:1;min-width:220px">
        </div>
        <div class="row" style="margin-top:10px">
          <div class="rowL">
            <button class="btn primary" id="signIn">Entrar</button>
            <button class="btn" id="signUp">Crear usuario</button>
          </div>
          <small>Tip: se loguea 1 vez y queda.</small>
        </div>
      </div>

      <div id="mainBox" style="display:none">
        <div class="row">
          <div class="rowL">
            <select class="in" id="albumSel"></select>
            <button class="btn" id="newAlbum">Nuevo √°lbum</button>
          </div>
          <div class="rowL">
            <button class="btn ok" id="scanBtn">üì∑ Escanear</button>
            <button class="btn" id="refreshBtn">üîÑ</button>
          </div>
        </div>

        <hr>

        <div class="card" style="padding:12px">
          <div class="row">
            <div style="min-width:220px">
              <div class="p">T√≠tulo de exposici√≥n</div>
              <input class="in" id="expoName" placeholder="Mi exposici√≥n" style="width:100%;margin-top:6px">
            </div>
            <div class="rowL">
              <button class="btn primary" id="saveExpo">Guardar t√≠tulo</button>
              <button class="btn ok" id="showQR">Ver QR</button>
            </div>
          </div>
          <div class="p" style="margin-top:10px">
            QR muestra solo lo que tenga ‚≠ê Exponer.
          </div>
        </div>

        <div class="grid" id="grid"></div>
      </div>
    </div>
  </div>
</div>

<!-- Camera modal -->
<div class="modal" id="camModal">
  <div class="modalCard">
    <div class="modalTop">
      <button class="btn" id="camBack">‚¨ÖÔ∏è Volver</button>
      <div class="t">üì∑ Escanear (solo c√°mara)</div>
      <button class="btn ok" id="camShot">üì∏ Capturar</button>
    </div>
    <div class="modalBody">
      <video id="vid" autoplay playsinline style="width:100%;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:#000"></video>
      <div class="p" style="margin-top:10px">Aline√° la hoja dentro del cuadro (imaginario). Despu√©s recortamos si quer√©s.</div>
    </div>
  </div>
</div>

<!-- QR modal -->
<div class="modal" id="qrModal">
  <div class="modalCard">
    <div class="modalTop">
      <button class="btn" id="qrBack">‚¨ÖÔ∏è Volver</button>
      <div class="t">üî≥ QR de la exposici√≥n</div>
      <button class="btn ok" id="copyLink">Copiar link</button>
    </div>
    <div class="modalBody">
      <div class="qrbox">
        <canvas id="qrCanvas" width="220" height="220"></canvas>
        <div>
          <div class="p">Link:</div>
          <div class="card" style="padding:10px;margin-top:6px">
            <div style="font-weight:900;font-size:12px;word-break:break-all" id="expoLink">‚Äî</div>
          </div>
          <small>Escane√° con c√°mara o compart√≠ el link.</small>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Listo</div>

<script>
/* ==========================
   CONFIG (PEG√Å TUS DATOS)
========================== */
const SUPABASE_URL = "https://vfvbssenzfbrnkydddxo.supabase.com";
const SUPABASE_ANON_KEY = "sb_publishable__3wLx8HB6dbL49gWL9Eyfw_kJPFh6kS";
const BUCKET = "drawings";

/* ==========================
   Basics
========================== */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = (id)=>document.getElementById(id);
const toast = $("toast");
function t(msg){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 1300); }
function qs(){ return new URLSearchParams(location.search); }
function randSlug(){
  const a = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let s=""; for(let i=0;i<10;i++) s += a[Math.floor(Math.random()*a.length)];
  return s;
}
function openModal(m){ m.classList.add("open"); }
function closeModal(m){ m.classList.remove("open"); }

let session = null;
let currentAlbumId = null;
let expo = null; // {id, title, slug}

/* ==========================
   MODE: EXPO (PUBLIC)
========================== */
async function runExpoMode(slug){
  $("adminApp").style.display = "none";
  $("expoOnly").style.display = "block";

  $("goHome").onclick = ()=>{ location.href = location.origin + location.pathname; };

  // expo by slug (anon allowed by policy)
  const { data: expos, error: e1 } = await supabase.from("expos")
    .select("id,title,slug,is_published,updated_at")
    .eq("slug", slug).eq("is_published", true).limit(1);

  if(e1 || !expos?.length){
    $("expoTitle").textContent = "Exposici√≥n no encontrada";
    $("expoSubtitle").textContent = "Revis√° el QR/link.";
    return;
  }

  const ex = expos[0];
  $("expoTitle").textContent = ex.title || "Exposici√≥n";
  $("expoSubtitle").textContent = "Modo museo";

  // items + join drawings
  const { data: items, error: e2 } = await supabase.from("expo_items")
    .select("position, drawings:drawings(id,title,image_path,expose)")
    .eq("expo_id", ex.id)
    .order("position", { ascending:true });

  if(e2){ $("expoSubtitle").textContent = "Error cargando dibujos."; return; }

  const grid = $("expoGrid");
  grid.innerHTML = "";

  for(const it of (items||[])){
    const d = it.drawings;
    if(!d || !d.expose) continue;

    const url = supabase.storage.from(BUCKET).getPublicUrl(d.image_path).data.publicUrl;

    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <img class="img" src="${url}" alt="">
      <div class="meta">
        <div class="name">${(d.title||"Sin nombre")}</div>
        <span class="tag">üé®</span>
      </div>
    `;
    grid.appendChild(el);
  }
}

/* ==========================
   MODE: ADMIN
========================== */
async function ensureSignedInUI(){
  $("adminApp").style.display = "block";
  $("expoOnly").style.display = "none";

  const { data } = await supabase.auth.getSession();
  session = data.session;

  $("loginBox").style.display = session ? "none" : "block";
  $("mainBox").style.display = session ? "block" : "none";
  $("logoutBtn").style.display = session ? "inline-flex" : "none";
  $("who").textContent = session ? (session.user.email || "Logueado") : "No logueado";

  if(session){
    await bootForUser();
  }
}

$("signUp").onclick = async ()=>{
  const email = $("email").value.trim();
  const pass  = $("pass").value;
  if(!email || !pass) return alert("Pon√© email y contrase√±a.");
  const { error } = await supabase.auth.signUp({ email, password: pass });
  if(error) return alert(error.message);
  t("Usuario creado ‚úÖ");
  await ensureSignedInUI();
};

$("signIn").onclick = async ()=>{
  const email = $("email").value.trim();
  const pass  = $("pass").value;
  if(!email || !pass) return alert("Pon√© email y contrase√±a.");
  const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
  if(error) return alert(error.message);
  t("Entr√≥ ‚úÖ");
  await ensureSignedInUI();
};

$("logoutBtn").onclick = async ()=>{
  await supabase.auth.signOut();
  t("Listo");
  await ensureSignedInUI();
};

async function bootForUser(){
  await ensureDefaultAlbum();
  await ensureExpo();
  await loadAlbums();
  await loadDrawings();
  $("expoName").value = expo?.title || "Mi exposici√≥n";
}

async function ensureDefaultAlbum(){
  // get first album
  const { data: albums } = await supabase.from("albums").select("id,name").order("created_at",{ascending:true}).limit(1);
  if(albums && albums.length){
    currentAlbumId = albums[0].id;
    return;
  }
  // create default
  const { data, error } = await supabase.from("albums").insert({ name:"Mis dibujos" }).select("id").limit(1);
  if(error) alert(error.message);
  currentAlbumId = data?.[0]?.id || null;
}

async function ensureExpo(){
  // one expo per user (simple)
  const { data: ex } = await supabase.from("expos").select("id,title,slug").order("created_at",{ascending:true}).limit(1);
  if(ex && ex.length){ expo = ex[0]; return; }

  const slug = randSlug();
  const { data, error } = await supabase.from("expos").insert({ title:"Mi exposici√≥n", slug, is_published:true }).select("id,title,slug").limit(1);
  if(error) return alert(error.message);
  expo = data[0];
}

async function loadAlbums(){
  const { data, error } = await supabase.from("albums").select("id,name").order("created_at",{ascending:true});
  if(error) return alert(error.message);

  const sel = $("albumSel");
  sel.innerHTML = "";
  for(const a of data){
    const opt = document.createElement("option");
    opt.value = a.id;
    opt.textContent = a.name;
    sel.appendChild(opt);
  }
  if(currentAlbumId) sel.value = currentAlbumId;
  sel.onchange = async ()=>{ currentAlbumId = sel.value; await loadDrawings(); };
}

$("newAlbum").onclick = async ()=>{
  const n = prompt("Nombre del √°lbum:", "Nuevo √°lbum");
  if(n === null) return;
  const name = (n||"").trim();
  if(!name) return;
  const { error } = await supabase.from("albums").insert({ name });
  if(error) return alert(error.message);
  t("√Ålbum creado ‚úÖ");
  await loadAlbums();
};

$("refreshBtn").onclick = async ()=>{ await loadDrawings(); t("Actualizado"); };

/* ===== Expo title & QR ===== */
$("saveExpo").onclick = async ()=>{
  if(!expo) return;
  const title = ($("expoName").value||"").trim() || "Mi exposici√≥n";
  const { data, error } = await supabase.from("expos").update({ title }).eq("id", expo.id).select("id,title,slug").limit(1);
  if(error) return alert(error.message);
  expo = data[0];
  t("T√≠tulo guardado ‚úÖ");
};

function expoURL(){
  const base = location.origin + location.pathname;
  return `${base}?expo=${encodeURIComponent(expo.slug)}`;
}

$("showQR").onclick = async ()=>{
  if(!expo) return;
  // sync expo items from current "expose" flags
  await syncExpoItems();

  const link = expoURL();
  $("expoLink").textContent = link;
  await QRCode.toCanvas($("qrCanvas"), link, { width:220, margin:2 });
  openModal($("qrModal"));
};

$("qrBack").onclick = ()=> closeModal($("qrModal"));
$("copyLink").onclick = async ()=>{
  try{ await navigator.clipboard.writeText($("expoLink").textContent); t("Copiado ‚úÖ"); }
  catch{ alert("No pude copiar. Copialo a mano."); }
};

async function syncExpoItems(){
  // we keep expo_items = all drawings with expose=true (simple)
  const { data: list, error } = await supabase.from("drawings")
    .select("id, expose, updated_at").order("created_at",{ascending:true});
  if(error) return;

  const exposed = list.filter(x=>x.expose).map((x,i)=>({ expo_id:expo.id, drawing_id:x.id, position:i }));

  // clear existing expo items
  await supabase.from("expo_items").delete().eq("expo_id", expo.id);

  // insert new
  if(exposed.length){
    const { error: e2 } = await supabase.from("expo_items").insert(exposed);
    if(e2) console.warn(e2.message);
  }
}

/* ==========================
   Drawings list
========================== */
async function loadDrawings(){
  const { data, error } = await supabase.from("drawings")
    .select("id,title,image_path,expose,created_at")
    .eq("album_id", currentAlbumId)
    .order("created_at", { ascending:false });

  if(error) return alert(error.message);

  const grid = $("grid");
  grid.innerHTML = "";

  for(const d of (data||[])){
    const url = supabase.storage.from(BUCKET).getPublicUrl(d.image_path).data.publicUrl;

    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <img class="img" src="${url}" alt="">
      <div class="meta">
        <div class="name">${(d.title||"Sin nombre")}</div>
        <button class="tag ${d.expose ? "on":""}" data-id="${d.id}">${d.expose ? "‚≠ê En expo" : "‚òÜ Exponer"}</button>
      </div>
    `;
    el.querySelector(".img").onclick = async ()=>{
      const n = prompt("Nombre del dibujo:", d.title || "");
      if(n===null) return;
      const title = (n||"").trim() || null;
      const { error } = await supabase.from("drawings").update({ title }).eq("id", d.id);
      if(error) return alert(error.message);
      t("Renombrado ‚úÖ");
      await loadDrawings();
    };
    el.querySelector(".tag").onclick = async ()=>{
      const next = !d.expose;
      const { error } = await supabase.from("drawings").update({ expose: next }).eq("id", d.id);
      if(error) return alert(error.message);
      t(next ? "Agregado a expo ‚≠ê" : "Sacado de expo");
      await loadDrawings();
    };

    grid.appendChild(el);
  }
}

/* ==========================
   CAMERA SCAN (solo c√°mara)
========================== */
let stream = null;

$("scanBtn").onclick = async ()=>{
  openModal($("camModal"));
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    $("vid").srcObject = stream;
  }catch(e){
    alert("No pude abrir la c√°mara. Revis√° permisos.");
    closeModal($("camModal"));
  }
};

$("camBack").onclick = ()=>{
  stopCam();
  closeModal($("camModal"));
};

function stopCam(){
  try{
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    $("vid").srcObject = null;
  }catch{}
}

$("camShot").onclick = async ()=>{
  if(!stream) return;

  // capture frame to canvas
  const v = $("vid");
  const c = document.createElement("canvas");
  const w = v.videoWidth || 1280;
  const h = v.videoHeight || 720;
  c.width = w; c.height = h;
  const ctx = c.getContext("2d");
  ctx.drawImage(v, 0, 0, w, h);

  // compress to jpeg blob
  const blob = await new Promise(res=> c.toBlob(res, "image/jpeg", 0.82));
  stopCam();
  closeModal($("camModal"));

  await uploadDrawingBlob(blob);
};

async function uploadDrawingBlob(blob){
  if(!session) return;

  const title = prompt("Nombre del dibujo (opcional):", "") || "";
  const id = crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(16).slice(2) + Date.now().toString(16));
  const path = `${session.user.id}/${id}.jpg`;

  // upload
  const { error: e1 } = await supabase.storage.from(BUCKET).upload(path, blob, {
    contentType: "image/jpeg",
    upsert: false
  });
  if(e1) return alert(e1.message);

  // insert meta
  const { error: e2 } = await supabase.from("drawings").insert({
    album_id: currentAlbumId,
    title: title.trim() || null,
    image_path: path,
    expose: false
  });
  if(e2) return alert(e2.message);

  t("Guardado ‚úÖ");
  await loadDrawings();
}

/* ==========================
   Start
========================== */
(async function(){
  const expoSlug = qs().get("expo");
  if(expoSlug){
    await runExpoMode(expoSlug);
    return;
  }
  await ensureSignedInUI();

  supabase.auth.onAuthStateChange(async ()=>{
    await ensureSignedInUI();
  });

  $("qrModal").addEventListener("click",(e)=>{ if(e.target===$("qrModal")) closeModal($("qrModal")); });
  $("camModal").addEventListener("click",(e)=>{ if(e.target===$("camModal")) { stopCam(); closeModal($("camModal")); } });
})();
</script>
</body>
</html>