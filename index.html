<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Martu-art ¬∑ Expos + Dibujos</title>
  <style>
    :root{
      --bg:#0f1115;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text:#e8ecf6;
      --muted: rgba(232,236,246,.62);
      --good:#44d07b;
      --bad:#ff5b6b;
      --brand:#7aa2ff;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r:22px;
      --press: translateY(1px) scale(.99);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 600px at 20% -10%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(68,208,123,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 80px}
    .hero{
      display:flex; gap:14px; align-items:stretch;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:28px;
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .logo{
      width:64px;height:64px;border-radius:18px;
      background: linear-gradient(180deg, rgba(122,162,255,.45), rgba(122,162,255,.08));
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 auto;
    }
    .hero h1{margin:0;font-size:30px;letter-spacing:.2px}
    .hero p{margin:6px 0 0;color:var(--muted)}
    .status{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      min-width: 210px;
      justify-content: space-between;
    }
    .pill{
      display:flex;align-items:center;gap:10px;
      font-weight:700;
    }
    .dot{
      width:11px;height:11px;border-radius:50%;
      background: var(--bad);
      box-shadow: 0 0 0 6px rgba(255,91,107,.12);
    }
    .dot.ok{
      background: var(--good);
      box-shadow: 0 0 0 6px rgba(68,208,123,.12);
    }
    .smallbtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:14px;
      padding:8px 10px;
      font-weight:700;
    }
    .smallbtn:active{transform:var(--press)}
    .tabs{
      margin-top:14px;
      display:flex; gap:12px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .tab{
      flex:1;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      padding:14px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(122,162,255,.35);
      background: rgba(122,162,255,.14);
    }
    .tab:active{transform:var(--press)}
    .panel{
      margin-top:12px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      border-radius:26px;
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    label{display:block;color:var(--muted);font-weight:700;margin:12px 0 8px}
    input,select{
      width:100%;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:14px 14px;
      font-size:16px;
      outline:none;
    }
    input::placeholder{color:rgba(232,236,246,.35)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1;min-width:220px}
    .btnrow{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    .btn{
      border-radius:20px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(122,162,255,.16);
      color:var(--text);
      padding:14px 16px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.alt{background: rgba(255,255,255,.06)}
    .btn:active{transform:var(--press)}
    .hint{margin-top:10px;color:var(--muted);line-height:1.35}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:16px 0}
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      z-index: 9999;
      background: rgba(0,0,0,.70);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 18px;
      box-shadow: var(--shadow);
      max-width: 92vw;
      font-weight:900;
      display:none;
    }
    .toast.show{display:block}
    .toast.bad{border-color: rgba(255,91,107,.45)}
    .toast.good{border-color: rgba(68,208,123,.45)}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap:12px;
    }
    .card{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .thumb{
      width:100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      display:block;
      background: rgba(255,255,255,.05);
    }
    .meta{padding:10px 10px;color:var(--muted);font-size:13px}
    .footerbar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 14px;
      background: rgba(15,17,21,.85);
      border-top:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      color: rgba(232,236,246,.70);
      font-weight:800;
      display:flex;justify-content:space-between;gap:10px;
      font-size:13px;
    }
  </style>

  <!-- Supabase JS loader con fallback (para Wi-Fi que bloquea cdnjs) -->
  <script>
    (function(){
      const sources = [
        "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js",
        "https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/supabase/2.45.4/umd/supabase.min.js"
      ];
      let i = 0;
      window.__supabaseReady = new Promise((resolve, reject) => {
        function next(){
          if(i >= sources.length) return reject(new Error("No carg√≥ Supabase JS (CDN bloqueado)."));
          const s = document.createElement("script");
          s.src = sources[i++];
          s.async = true;
          s.onload = () => resolve(true);
          s.onerror = () => next();
          document.head.appendChild(s);
        }
        next();
      });
    })();
  </script>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="logo"></div>
      <div>
        <h1>Martu-art</h1>
        <p>Expos + Dibujos (GitHub Pages + Supabase)</p>
      </div>
      <div class="status" title="Estado de conexi√≥n">
        <div class="pill"><span id="dot" class="dot"></span><span id="statusTxt">Conectando‚Ä¶</span></div>
        <button class="smallbtn" id="btnRetry" type="button">‚Üª</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="expos">üìÅ Expos</div>
      <div class="tab" data-tab="upload">‚¨ÜÔ∏è Subir dibujo</div>
      <div class="tab" data-tab="gallery">üñºÔ∏è Galer√≠a</div>
    </div>

    <!-- EXPOS -->
    <section class="panel" id="panel-expos">
      <div class="hint">Cre√° una expo (se autogenera el slug). Despu√©s pod√©s compartir el link.</div>

      <label>Nombre de la expo</label>
      <input id="expoName" placeholder="Ej: Primavera 2026, Dinosaurios, etc." />

      <label>Slug (se autogenera)</label>
      <input id="expoSlug" placeholder="ej: primavera-2026" disabled />

      <div class="btnrow">
        <button class="btn" id="btnCreateExpo" type="button">Crear expo</button>
        <button class="btn alt" id="btnRefreshExpos" type="button">Actualizar lista</button>
      </div>

      <div class="divider"></div>

      <label>Expo seleccionada</label>
      <select id="expoSelect">
        <option value="">‚Äî Eleg√≠ una expo ‚Äî</option>
      </select>

      <label>Link de la expo (para compartir)</label>
      <input id="expoLink" placeholder="Se completa al elegir una expo" disabled />

      <div class="btnrow">
        <button class="btn alt" id="btnCopyLink" type="button">Copiar link</button>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="card">
          <div class="meta"><b id="countExpos">0</b><br/>Expos creadas</div>
        </div>
        <div class="card">
          <div class="meta"><b id="countDrawings">0</b><br/>Dibujos en esta expo</div>
        </div>
      </div>
    </section>

    <!-- UPLOAD -->
    <section class="panel" id="panel-upload" style="display:none">
      <div class="hint">Sub√≠ una foto del dibujo (jpg/png). Se guarda en el bucket y queda en la expo seleccionada.</div>

      <label>Archivo (foto del dibujo)</label>
      <input id="file" type="file" accept="image/*" />

      <label>T√≠tulo (opcional)</label>
      <input id="title" placeholder="Ej: Gatito, Arcoiris, etc." />

      <div class="btnrow">
        <button class="btn" id="btnUpload" type="button">Subir</button>
        <button class="btn alt" id="btnGoGallery" type="button">Ver galer√≠a</button>
      </div>

      <div class="divider"></div>
      <div class="hint" id="debugLine">Modo: P√∫blico (sin login) ¬∑ bucket: <b>drawings</b></div>
    </section>

    <!-- GALLERY -->
    <section class="panel" id="panel-gallery" style="display:none">
      <div class="hint">Muestra los dibujos de la expo seleccionada.</div>
      <div class="btnrow">
        <button class="btn" id="btnLoadGallery" type="button">Cargar galer√≠a</button>
        <button class="btn alt" id="btnBackExpos" type="button">Volver a expos</button>
      </div>
      <div class="grid" id="grid"></div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <div class="footerbar">
    <div>Estado: <span id="footerState">‚Äî</span></div>
    <div>bucket: <span id="footerBucket">drawings</span></div>
  </div>

<script>
/*** CONFIG (YA LISTO) ***/
const SUPABASE_URL = "https://vfvbssenzfbrnkydddxo.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable__3wLx8HB6dbL49gWL9Eyfw_kJPFh6kS";
const BUCKET = "drawings";

/*** UI helpers ***/
const $ = (id)=>document.getElementById(id);
const toast = (msg, ok=null)=>{
  const t=$("toast");
  t.textContent = msg;
  t.className = "toast show" + (ok===true?" good": ok===false?" bad":"");
  setTimeout(()=>t.classList.remove("show"), 2400);
};
const setStatus = (ok, text)=>{
  $("dot").className = "dot" + (ok ? " ok":"");
  $("statusTxt").textContent = text;
  $("footerState").textContent = ok ? "ok" : "error";
};

/*** Tabs ***/
const showTab = (name)=>{
  document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active", x.dataset.tab===name));
  $("panel-expos").style.display = name==="expos" ? "" : "none";
  $("panel-upload").style.display = name==="upload" ? "" : "none";
  $("panel-gallery").style.display = name==="gallery" ? "" : "none";
};
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>showTab(tab.dataset.tab));
});

/*** Slugify ***/
const slugify = (s)=>{
  return (s||"")
    .toString()
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/(^-|-$)/g,"")
    .slice(0,60);
};

$("expoName").addEventListener("input", ()=>{
  $("expoSlug").value = slugify($("expoName").value);
});

/*** Supabase init with CDN fallback ***/
let supabase = null;

async function init(){
  setStatus(false, "Conectando‚Ä¶");
  try{
    await window.__supabaseReady;
    if(!window.supabase || !window.supabase.createClient){
      throw new Error("Supabase JS carg√≥ pero no est√° disponible.");
    }
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // prueba r√°pida: listar expos
    const { error } = await supabase.from("expos").select("id").limit(1);
    if(error) throw error;
    setStatus(true, "Conectado ‚úÖ");
    toast("Conectado ‚úÖ", true);
    await refreshExpos();
    // si viene con ?expo=slug
    const params = new URLSearchParams(location.search);
    const q = params.get("expo");
    if(q){
      await refreshExpos();
      // seleccionar si existe
      const opt = Array.from($("expoSelect").options).find(o=>o.value===q);
      if(opt){ $("expoSelect").value = q; onSelectExpo(); }
      showTab("gallery");
      await loadGallery();
    }
  }catch(e){
    console.error(e);
    setStatus(false, "JS no carg√≥ ‚ùå");
    toast("JS no carg√≥ ‚ùå (Wi-Fi/CDN bloqueado)", false);
  }
}

$("btnRetry").addEventListener("click", ()=>location.reload());

/*** Expos ***/
async function refreshExpos(){
  if(!supabase) return;
  const { data, error } = await supabase
    .from("expos")
    .select("title,slug,created_at")
    .order("created_at", { ascending:false });

  if(error){
    console.error(error);
    toast("Error cargando expos ‚ùå", false);
    return;
  }
  $("expoSelect").innerHTML = `<option value="">‚Äî Eleg√≠ una expo ‚Äî</option>` +
    (data||[]).map(x=>`<option value="${x.slug}">${x.title} (${x.slug})</option>`).join("");

  $("countExpos").textContent = (data||[]).length;
}

async function createExpo(){
  if(!supabase) return toast("No hay conexi√≥n a Supabase", false);
  const title = $("expoName").value.trim();
  const slug = slugify(title);
  if(!title) return toast("Pon√© un nombre de expo", false);

  const { error } = await supabase.from("expos").insert([{ title, slug }]);
  if(error){
    console.error(error);
    toast("No pudo crear expo ‚ùå", false);
    return;
  }
  toast("Expo creada ‚úÖ", true);
  $("expoName").value="";
  $("expoSlug").value="";
  await refreshExpos();
  $("expoSelect").value = slug;
  onSelectExpo();
}

function onSelectExpo(){
  const slug = $("expoSelect").value;
  if(!slug){
    $("expoLink").value="";
    $("countDrawings").textContent="0";
    return;
  }
  const url = `${location.origin}${location.pathname}?expo=${encodeURIComponent(slug)}`;
  $("expoLink").value = url;
  // refrescar conteo dibujos
  countDrawings(slug);
}

async function countDrawings(slug){
  if(!supabase) return;
  // obtenemos expo id
  const { data: ex, error: e1 } = await supabase.from("expos").select("id").eq("slug", slug).single();
  if(e1){ console.error(e1); return; }
  const { count, error: e2 } = await supabase
    .from("drawings")
    .select("id", { count:"exact", head:true })
    .eq("album_id", ex.id);
  if(e2){ console.error(e2); return; }
  $("countDrawings").textContent = count ?? 0;
}

$("btnCreateExpo").addEventListener("click", createExpo);
$("btnRefreshExpos").addEventListener("click", refreshExpos);
$("expoSelect").addEventListener("change", onSelectExpo);

$("btnCopyLink").addEventListener("click", async ()=>{
  const v = $("expoLink").value;
  if(!v) return toast("Eleg√≠ una expo primero", false);
  try{ await navigator.clipboard.writeText(v); toast("Link copiado ‚úÖ", true); }
  catch{ toast("No pude copiar (iPhone a veces molesta). Manten√© apretado y copi√°.", false); }
});

/*** Upload ***/
async function upload(){
  if(!supabase) return toast("No hay conexi√≥n a Supabase", false);

  const slug = $("expoSelect").value;
  if(!slug) return toast("Eleg√≠ una expo primero", false);

  const f = $("file").files[0];
  if(!f) return toast("Eleg√≠ una imagen", false);

  // buscar expo id
  const { data: ex, error: e1 } = await supabase.from("expos").select("id").eq("slug", slug).single();
  if(e1){ console.error(e1); return toast("No encontr√© la expo", false); }

  // subir a Storage
  const ext = (f.name.split(".").pop() || "jpg").toLowerCase().slice(0,6);
  const safeExt = ["jpg","jpeg","png","webp"].includes(ext) ? ext : "jpg";
  const path = `${slug}/${Date.now()}_${Math.random().toString(16).slice(2)}.${safeExt}`;

  const up = await supabase.storage.from(BUCKET).upload(path, f, { upsert:false });
  if(up.error){
    console.error(up.error);
    return toast("No subi√≥ ‚ùå (permisos bucket)", false);
  }

  // obtener URL p√∫blica
  const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(path);
  const image_url = pub?.publicUrl || "";

  // guardar en DB
  const title = $("title").value.trim() || null;
  const ins = await supabase.from("drawings").insert([{
    album_id: ex.id,
    title,
    image_url,
    file_path: path
  }]);

  if(ins.error){
    console.error(ins.error);
    toast("Subi√≥ pero no guard√≥ en DB ‚ùå", false);
    return;
  }

  toast("Subido ‚úÖ", true);
  $("file").value = "";
  $("title").value = "";
  await countDrawings(slug);
}

$("btnUpload").addEventListener("click", upload);
$("btnGoGallery").addEventListener("click", async ()=>{
  showTab("gallery");
  await loadGallery();
});

/*** Gallery ***/
async function loadGallery(){
  if(!supabase) return toast("No hay conexi√≥n a Supabase", false);
  const slug = $("expoSelect").value;
  if(!slug) return toast("Eleg√≠ una expo primero", false);

  const { data: ex, error: e1 } = await supabase.from("expos").select("id").eq("slug", slug).single();
  if(e1){ console.error(e1); return toast("No encontr√© la expo", false); }

  const { data, error } = await supabase
    .from("drawings")
    .select("id,title,image_url,created_at")
    .eq("album_id", ex.id)
    .order("created_at", { ascending:false });

  if(error){
    console.error(error);
    return toast("Error cargando galer√≠a ‚ùå", false);
  }

  const grid = $("grid");
  grid.innerHTML = (data||[]).map(d=>{
    const t = (d.title || "Sin t√≠tulo");
    const img = d.image_url || "";
    return `
      <div class="card">
        <img class="thumb" src="${img}" alt="${t}" loading="lazy" />
        <div class="meta"><b>${escapeHtml(t)}</b></div>
      </div>
    `;
  }).join("");

  toast("Galer√≠a lista ‚úÖ", true);
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

$("btnLoadGallery").addEventListener("click", loadGallery);
$("btnBackExpos").addEventListener("click", ()=>showTab("expos"));

/*** go ***/
init();
</script>
</body>
</html>