<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Martu-art</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f1115;
      --panel:rgba(20,24,32,.72);
      --stroke:rgba(255,255,255,.10);
      --text:#e8ecf6;
      --muted:rgba(232,236,246,.62);
      --brand:#7aa2ff;
      --ok:#44d07b;
      --bad:#ff5b6b;
      --r:18px;
      --shadow:0 14px 40px rgba(0,0,0,.55);
      --press: translateY(1px) scale(.99);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(122,162,255,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(68,208,123,.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 74px}
    .hero{
      display:flex;align-items:center;gap:12px;
      padding:14px;border:1px solid var(--stroke);border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      position:sticky;top:10px;backdrop-filter: blur(10px);z-index:5;
    }
    .avatar{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg, rgba(122,162,255,.85), rgba(255,255,255,.08));border:1px solid var(--stroke)}
    .hero h1{font-size:22px;margin:0;line-height:1.1}
    .hero .sub{color:var(--muted);font-size:13px;margin-top:3px}
    .pill{
      margin-left:auto;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      font-weight:650;
    }
    .dot{width:10px;height:10px;border-radius:99px;background:var(--bad);box-shadow:0 0 0 3px rgba(255,91,107,.15)}
    .pill.ok .dot{background:var(--ok);box-shadow:0 0 0 3px rgba(68,208,123,.16)}
    .tabs{
      margin-top:14px;
      display:flex;gap:10px;
      padding:10px;border-radius:22px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      box-shadow:var(--shadow);
    }
    .tab{
      flex:1;
      cursor:pointer;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      border-radius:16px;
      padding:12px 10px;
      font-weight:750;
      display:flex;gap:10px;align-items:center;justify-content:center;
      user-select:none;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .tab:active{transform:var(--press)}
    .tab.active{background:rgba(122,162,255,.14);border-color:rgba(122,162,255,.35)}
    .panel{
      margin-top:12px;
      border:1px solid var(--stroke);
      border-radius:22px;
      background:var(--panel);
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:220px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(232,236,246,.35)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      cursor:pointer;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:12px 14px;
      border-radius:16px;
      font-weight:800;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn.primary{background:rgba(122,162,255,.18);border-color:rgba(122,162,255,.35)}
    .btn:active{transform:var(--press)}
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .hr{height:1px;background:var(--stroke);margin:14px 0}
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      padding:12px 14px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.55);backdrop-filter:blur(10px);
      color:var(--text);font-weight:800;
      opacity:0;pointer-events:none;transition:opacity .2s ease;
      max-width:min(92vw, 880px);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .toast.show{opacity:1}
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (min-width:860px){
      .grid{grid-template-columns: repeat(3, minmax(0,1fr));}
    }
    .card{
      border:1px solid var(--stroke);
      border-radius:18px;
      background:rgba(255,255,255,.03);
      overflow:hidden;
    }
    .thumb{
      width:100%;
      aspect-ratio: 4/3;
      object-fit:cover;
      display:block;
      background:rgba(0,0,0,.25);
    }
    .card .meta{padding:10px 10px 12px}
    .title{font-weight:850}
    .small{font-size:12px;color:var(--muted);margin-top:4px}
    .note{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .kpi .box{
      flex:1;min-width:190px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:rgba(255,255,255,.03);
      padding:12px;
    }
    .kpi .n{font-weight:950;font-size:22px}
    .kpi .l{color:var(--muted);font-size:12px;margin-top:4px}
    .ghost{opacity:.55}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="avatar"></div>
      <div>
        <h1>Martu-art</h1>
        <div class="sub">Expos + Dibujos (GitHub Pages + Supabase)</div>
      </div>
      <div id="pill" class="pill">
        <span id="dot" class="dot"></span>
        <span id="pillText">Conectando‚Ä¶</span>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="expos">üìÅ Expos</div>
      <div class="tab" data-tab="upload">‚¨ÜÔ∏è Subir dibujo</div>
      <div class="tab" data-tab="gallery">üñºÔ∏è Galer√≠a</div>
    </div>

    <div class="panel" id="tab-expos">
      <div class="muted">Cre√° una expo (se autogenera el slug). Despu√©s pod√©s compartir el link.</div>

      <label>Nombre de la expo</label>
      <input id="expoName" placeholder="Ej: Primavera 2026, Dinosaurios, etc."/>

      <label>Slug (se autogenera)</label>
      <input id="expoSlug" class="ghost" placeholder="ej: primavera-2026" disabled/>

      <div class="btns">
        <button class="btn primary" id="btnCreateExpo">Crear expo</button>
        <button class="btn" id="btnRefreshExpos">Actualizar lista</button>
      </div>

      <div class="hr"></div>

      <label>Expo seleccionada</label>
      <select id="expoSelect">
        <option value="">‚Äî Eleg√≠ una expo ‚Äî</option>
      </select>

      <label>Link de la expo (para compartir)</label>
      <input id="expoLink" readonly />

      <div class="btns">
        <button class="btn" id="btnCopyLink">Copiar link</button>
      </div>

      <div class="kpi">
        <div class="box"><div class="n" id="kpiExpos">0</div><div class="l">Expos creadas</div></div>
        <div class="box"><div class="n" id="kpiDrawings">0</div><div class="l">Dibujos en esta expo</div></div>
      </div>
    </div>

    <div class="panel" id="tab-upload" style="display:none">
      <div class="muted">Sub√≠ una foto del dibujo (jpg/png). Se guarda en el bucket y queda linkeada a la expo seleccionada.</div>

      <label>Archivo (foto del dibujo)</label>
      <input id="file" type="file" accept="image/*"/>

      <label>T√≠tulo (opcional)</label>
      <input id="drawingTitle" placeholder="Ej: Gatito, Arcoiris, etc."/>

      <div class="btns">
        <button class="btn primary" id="btnUpload">Subir</button>
        <button class="btn" id="btnGoGallery">Ver galer√≠a</button>
      </div>

      <div class="note">
        Si sube a Storage pero falla en DB, es porque la tabla/policies no coinciden. Con este c√≥digo usamos <b>drawings.image_url</b> (que vos s√≠ ten√©s).
      </div>
    </div>

    <div class="panel" id="tab-gallery" style="display:none">
      <div class="muted">Muestra los dibujos de la expo seleccionada.</div>
      <div class="btns">
        <button class="btn primary" id="btnLoadGallery">Cargar galer√≠a</button>
      </div>
      <div id="gallery" class="grid"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* =========================
   CONFIG (PEG√Å TUS DATOS)
========================= */
const SUPABASE_URL = "https://vfvbssenzfbrnkydddxo.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable__3wLx8HB6dbL49gWL9Eyfw_kJPFh6kS"; // sb_publishable_...
const BUCKET = "drawings"; // nombre del bucket en Storage

/* =========================
   APP
========================= */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (id)=>document.getElementById(id);
const toast = (msg, bad=false)=>{
  const t = $("toast");
  t.textContent = msg;
  t.style.borderColor = bad ? "rgba(255,91,107,.40)" : "rgba(68,208,123,.35)";
  t.classList.add("show");
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 2200);
};

const setConn = (ok, msg)=>{
  const pill = $("pill");
  const dot = $("dot");
  $("pillText").textContent = msg;
  pill.classList.toggle("ok", !!ok);
};

function slugify(s){
  return (s||"")
    .trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-+|-+$/g,"")
    .slice(0,60) || "expo";
}

function baseUrl(){
  // GitHub Pages user site: https://matiasepena-star.github.io/
  // Si est√°s con /index.html tambi√©n sirve, pero NO uses /index.html/ (con barra al final)
  const u = new URL(window.location.href);
  u.search = "";
  u.hash = "";
  return u.toString();
}

async function testConn(){
  try{
    // prueba simple: pedir 1 fila de expos
    const { error } = await supabase.from("expos").select("id").limit(1);
    if (error) throw error;
    setConn(true, "Conectado ‚úÖ");
    return true;
  }catch(e){
    setConn(false, "No conectado ‚ùå");
    toast("Error Supabase: " + (e.message||e), true);
    return false;
  }
}

async function refreshExpos(selectSlugToPick=null){
  const { data, error } = await supabase
    .from("expos")
    .select("id,title,slug,created_at")
    .order("created_at", { ascending:false });

  if (error){ toast("Error cargando expos ‚ùå", true); return; }

  $("kpiExpos").textContent = data.length;

  const sel = $("expoSelect");
  const prev = sel.value;
  sel.innerHTML = `<option value="">‚Äî Eleg√≠ una expo ‚Äî</option>` + data.map(x=>{
    return `<option value="${x.id}" data-slug="${x.slug}">${x.title} (${x.slug})</option>`;
  }).join("");

  // seleccionar
  if (selectSlugToPick){
    const opt = [...sel.options].find(o=>o.getAttribute("data-slug")===selectSlugToPick);
    if (opt) sel.value = opt.value;
  } else if (prev) {
    sel.value = prev;
  }

  updateExpoLink();
  await refreshKpis();
}

async function refreshKpis(){
  const expoId = $("expoSelect").value;
  if (!expoId){ $("kpiDrawings").textContent = "0"; return; }

  const { count, error } = await supabase
    .from("expo_items")
    .select("id", { count:"exact", head:true })
    .eq("expo_id", expoId);

  if (error){ $("kpiDrawings").textContent = "0"; return; }
  $("kpiDrawings").textContent = String(count ?? 0);
}

function updateExpoLink(){
  const sel = $("expoSelect");
  const opt = sel.options[sel.selectedIndex];
  const slug = opt?.getAttribute("data-slug") || "";
  if (!slug){ $("expoLink").value = ""; return; }

  const u = new URL(baseUrl());
  u.searchParams.set("expo", slug);
  $("expoLink").value = u.toString();
}

async function ensureExpoSelected(){
  const expoId = $("expoSelect").value;
  if (!expoId){
    toast("Eleg√≠ una expo primero üôè", true);
    return null;
  }
  const opt = $("expoSelect").options[$("expoSelect").selectedIndex];
  return { expoId, expoSlug: opt.getAttribute("data-slug") };
}

async function createExpo(){
  const name = $("expoName").value.trim();
  if (!name){ toast("Pon√© un nombre de expo", true); return; }
  const slug = slugify(name);
  $("expoSlug").value = slug;

  const { data:existing, error:err1 } = await supabase.from("expos").select("id").eq("slug", slug).limit(1);
  if (err1){ toast("Error verificando slug ‚ùå", true); return; }
  if (existing && existing.length){
    toast("Ese slug ya existe. Cambi√° el nombre o agreg√° algo.", true);
    return;
  }

  const { error } = await supabase.from("expos").insert({ title:name, slug });
  if (error){ toast("No pudo crear expo ‚ùå " + error.message, true); return; }

  toast("Expo creada ‚úÖ");
  $("expoName").value = "";
  $("expoSlug").value = "";
  await refreshExpos(slug);
}

async function uploadDrawing(){
  const ok = await testConn();
  if (!ok) return;

  const expo = await ensureExpoSelected();
  if (!expo) return;

  const file = $("file").files?.[0];
  if (!file){ toast("Eleg√≠ una imagen", true); return; }

  const title = $("drawingTitle").value.trim() || null;

  // nombre √∫nico
  const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
  const safeExt = ext.match(/^(jpg|jpeg|png|webp|gif)$/) ? ext : "jpg";
  const path = `${expo.expoSlug}/${Date.now()}-${Math.random().toString(16).slice(2)}.${safeExt}`;

  // 1) sube a storage
  const { error: upErr } = await supabase.storage.from(BUCKET).upload(path, file, {
    cacheControl: "3600",
    upsert: false,
    contentType: file.type || "image/jpeg"
  });
  if (upErr){
    toast("No subi√≥ a Storage ‚ùå " + upErr.message, true);
    return;
  }

  // 2) arma URL p√∫blica (bucket PUBLIC)
  const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(path);
  const image_url = pub?.publicUrl;
  if (!image_url){
    toast("Subi√≥ pero no pude generar URL p√∫blica ‚ùå", true);
    return;
  }

  // 3) inserta en DB (SOLO columnas que existen)
  const { data: drow, error: dbErr } = await supabase
    .from("drawings")
    .insert({ title, image_url })
    .select("id")
    .single();

  if (dbErr){
    toast("Subi√≥ a Storage pero fall√≥ DB ‚ùå " + dbErr.message, true);
    return;
  }

  // 4) linkea con la expo
  const { error: linkErr } = await supabase
    .from("expo_items")
    .insert({ expo_id: expo.expoId, drawing_id: drow.id });

  if (linkErr){
    toast("Guard√≥ dibujo pero no linke√≥ expo ‚ùå " + linkErr.message, true);
    return;
  }

  toast("Subido y guardado ‚úÖ");
  $("file").value = "";
  $("drawingTitle").value = "";
  await refreshKpis();
}

async function loadGallery(){
  const ok = await testConn();
  if (!ok) return;

  const expo = await ensureExpoSelected();
  if (!expo) return;

  // trae drawings por join con expo_items
  const { data, error } = await supabase
    .from("expo_items")
    .select("drawing_id, drawings:drawings(id,title,image_url,created_at)")
    .eq("expo_id", expo.expoId)
    .order("drawing_id", { ascending:false });

  if (error){
    toast("Error cargando galer√≠a ‚ùå " + error.message, true);
    return;
  }

  const items = (data||[])
    .map(x => x.drawings)
    .filter(Boolean)
    .filter(d => d.image_url);

  const g = $("gallery");
  if (!items.length){
    g.innerHTML = `<div class="muted">No hay dibujos todav√≠a en esta expo.</div>`;
    $("kpiDrawings").textContent = "0";
    return;
  }

  g.innerHTML = items.map(d=>{
    const t = (d.title || "Sin t√≠tulo").replace(/</g,"&lt;");
    const dt = d.created_at ? new Date(d.created_at).toLocaleString() : "";
    return `
      <div class="card">
        <img class="thumb" src="${d.image_url}" alt="${t}" loading="lazy"/>
        <div class="meta">
          <div class="title">${t}</div>
          <div class="small">${dt}</div>
        </div>
      </div>
    `;
  }).join("");

  $("kpiDrawings").textContent = String(items.length);
  toast("Galer√≠a lista ‚úÖ");
}

/* Tabs */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const k = t.dataset.tab;
    ["expos","upload","gallery"].forEach(id=>{
      $("tab-"+id).style.display = (id===k) ? "" : "none";
    });
  });
});

/* Events */
$("expoName").addEventListener("input", ()=>{
  $("expoSlug").value = slugify($("expoName").value);
});
$("btnCreateExpo").addEventListener("click", createExpo);
$("btnRefreshExpos").addEventListener("click", ()=>refreshExpos());
$("expoSelect").addEventListener("change", async ()=>{
  updateExpoLink();
  await refreshKpis();
});
$("btnCopyLink").addEventListener("click", async ()=>{
  const v = $("expoLink").value;
  if (!v){ toast("Eleg√≠ una expo", true); return; }
  await navigator.clipboard.writeText(v);
  toast("Link copiado ‚úÖ");
});
$("btnUpload").addEventListener("click", uploadDrawing);
$("btnLoadGallery").addEventListener("click", loadGallery);
$("btnGoGallery").addEventListener("click", ()=>{
  document.querySelector('.tab[data-tab="gallery"]').click();
  loadGallery();
});

/* Init */
(async ()=>{
  await testConn();
  await refreshExpos();

  // si viene con ?expo=slug en el link compartido, autoselecciona
  const params = new URLSearchParams(location.search);
  const slug = params.get("expo");
  if (slug){
    await refreshExpos(slug);
    document.querySelector('.tab[data-tab="gallery"]').click();
    await loadGallery();
  }
})();
</script>
</body>
</html>