<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Martu-art</title>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:#e8ecf6;
      --muted:rgba(232,236,246,.62);
      --good:#44d07b;
      --bad:#ff5b6b;
      --brand:#7aa2ff;
      --brand2:#9b7aff;
      --shadow: 0 16px 44px rgba(0,0,0,.55);
      --r:22px;
      --press: translateY(1px) scale(.99);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 680px at 15% -10%, rgba(122,162,255,.20), transparent 60%),
        radial-gradient(900px 600px at 110% 10%, rgba(155,122,255,.14), transparent 55%),
        radial-gradient(800px 600px at 40% 120%, rgba(68,208,123,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 90px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius:var(--r);
      box-shadow:var(--shadow);
    }
    .brand{display:flex;gap:12px;align-items:center;min-width:0}
    .pill{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(180deg, rgba(122,162,255,.55), rgba(155,122,255,.35));
      border:1px solid rgba(255,255,255,.15);
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .titles{min-width:0}
    .titles h1{margin:0;font-size:22px}
    .titles p{margin:2px 0 0;color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .status{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      flex:0 0 auto;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--bad);box-shadow:0 0 0 6px rgba(255,91,107,.12)}
    .status b{font-weight:800}
    .status small{color:var(--muted)}
    .btn-mini{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .btn-mini:active{transform:var(--press)}

    .tabs{
      margin-top:12px;
      display:flex;gap:10px;
      padding:12px;
      border-radius:var(--r);
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      box-shadow:var(--shadow);
    }
    .tab{
      flex:1;
      display:flex;align-items:center;justify-content:center;
      gap:10px;
      padding:14px 12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      min-height:54px;
    }
    .tab.active{
      background:rgba(122,162,255,.12);
      border-color: rgba(122,162,255,.35);
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .tab:active{transform:var(--press)}

    .card{
      margin-top:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .inner{padding:14px}
    .hint{color:var(--muted);font-size:13px;line-height:1.35}

    label{display:block;margin:12px 0 6px;color:var(--muted);font-size:13px}
    input,select{
      width:100%;
      padding:12px 12px;
      background:rgba(0,0,0,.22);
      border:1px solid var(--stroke);
      color:var(--text);
      border-radius:14px;
      outline:none;
      font-size:15px;
    }
    input::placeholder{color:rgba(232,236,246,.38)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      min-width:160px;
      text-align:center;
    }
    .btn.primary{
      background:rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.40);
    }
    .btn:active{transform:var(--press)}
    .btn[disabled]{opacity:.5;cursor:not-allowed;transform:none}

    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}

    .toast{
      position:fixed;left:12px;right:12px;bottom:14px;
      max-width:980px;margin:0 auto;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.78);
      color:var(--text);
      border-radius:16px;
      padding:12px 14px;
      box-shadow:var(--shadow);
      transform:translateY(18px);
      opacity:0;
      transition:.18s ease;
      pointer-events:none;
      z-index:99;
    }
    .toast.show{transform:translateY(0);opacity:1}
    .toast b{font-weight:900}
    .toast .sub{color:var(--muted);font-size:13px;margin-top:2px}

    .grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }

    .imgcard{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      border-radius:18px;
      overflow:hidden;
      cursor:pointer;
    }
    .imgcard img{width:100%;display:block;aspect-ratio: 4/3;object-fit:cover;background:rgba(255,255,255,.03)}
    .imgcard .meta{padding:10px 12px}
    .imgcard .meta b{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .imgcard .meta small{color:var(--muted)}

    .modal{
      position:fixed;inset:0;
      background:rgba(0,0,0,.72);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:100;
    }
    .modal.open{display:flex}
    .modal .box{
      width:min(980px, 100%);
      border:1px solid var(--stroke);
      background:rgba(12,14,18,.92);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal .bar{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10)
    }
    .modal .bar b{font-weight:900}
    .modal .bar button{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .modal .bar button:active{transform:var(--press)}
    .modal .content{padding:12px}
    .bigimg{width:100%;max-height:75vh;object-fit:contain;background:rgba(255,255,255,.03);border-radius:14px}

    .foot{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(7,10,14,.72);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      z-index:50;
    }
    .foot .inner{
      max-width:980px;margin:0 auto;
      display:flex;gap:10px;justify-content:space-between;align-items:center;
      color:var(--muted);font-size:12px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="pill"></div>
        <div class="titles">
          <h1>Martu-art</h1>
          <p>Expos + Dibujos (GitHub Pages + Supabase)</p>
        </div>
      </div>

      <div class="status">
        <span class="dot" id="dot"></span>
        <div>
          <b id="statusText">Conectando‚Ä¶</b><br/>
          <small id="statusSub">cargando librer√≠a</small>
        </div>
        <button class="btn-mini" id="btnRetry" title="Reintentar">‚Üª</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="expos">üìÅ Expos</div>
      <div class="tab" data-tab="subir">‚¨ÜÔ∏è Subir dibujo</div>
      <div class="tab" data-tab="galeria">üñºÔ∏è Galer√≠a</div>
    </div>

    <div class="card" id="panel-expos">
      <div class="inner">
        <div class="hint">Cre√° una expo (se autogenera el slug). Despu√©s pod√©s compartir el link.</div>

        <label>Nombre de la expo</label>
        <input id="expoTitle" placeholder="Ej: Primavera 2026, Dinosaurios, etc."/>

        <label>Slug (se autogenera)</label>
        <input id="expoSlug" placeholder="ej: primavera-2026" disabled/>

        <div class="btns">
          <div class="btn primary" id="btnCreateExpo">Crear expo</div>
          <div class="btn" id="btnRefreshExpos">Actualizar lista</div>
        </div>

        <div class="divider"></div>

        <label>Expo seleccionada</label>
        <select id="expoSelect">
          <option value="">‚Äî Eleg√≠ una expo ‚Äî</option>
        </select>

        <label>Link de la expo (para compartir)</label>
        <input id="expoLink" placeholder="Se completa al elegir una expo" readonly/>

        <div class="btns">
          <div class="btn" id="btnCopyLink">Copiar link</div>
        </div>
      </div>
    </div>

    <div class="card" id="panel-subir" style="display:none">
      <div class="inner">
        <div class="hint">Sub√≠ una foto del dibujo (jpg/png). Se guarda en el bucket y queda en la expo seleccionada.</div>

        <label>Archivo (foto del dibujo)</label>
        <input id="file" type="file" accept="image/*"/>

        <label>T√≠tulo (opcional)</label>
        <input id="drawTitle" placeholder="Ej: Gatito, Arcoiris, etc."/>

        <div class="btns">
          <div class="btn primary" id="btnUpload">Subir</div>
          <div class="btn" id="btnGoGallery">Ver galer√≠a</div>
        </div>
      </div>
    </div>

    <div class="card" id="panel-galeria" style="display:none">
      <div class="inner">
        <div class="hint">Mostramos la galer√≠a de la expo elegida.</div>
        <div class="btns">
          <div class="btn primary" id="btnLoadGallery">Cargar / Actualizar</div>
        </div>
        <div class="divider"></div>
        <div id="galleryGrid" class="grid"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="box">
      <div class="bar">
        <b id="modalTitle">Dibujo</b>
        <button id="modalClose">Cerrar</button>
      </div>
      <div class="content">
        <img id="modalImg" class="bigimg" src="" alt=""/>
      </div>
    </div>
  </div>

  <div class="foot">
    <div class="inner">
      <div>Estado: <span class="mono" id="footState">‚Äî</span></div>
      <div class="mono" id="footBucket">bucket: ‚Äî</div>
    </div>
  </div>

  <div class="toast" id="toast">
    <b id="toastTitle">Listo</b>
    <div class="sub" id="toastSub"></div>
  </div>

<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = "https://vfvbssenzfbrnkydddxo.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable__3wLx8HB6dbL49gWL9Eyfw_kJPFh6kS";
const BUCKET = "drawings";

/* ========= UI ========= */
const $ = (id)=>document.getElementById(id);
function toast(title, sub=""){
  $("toastTitle").textContent = title;
  $("toastSub").textContent = sub;
  $("toast").classList.add("show");
  setTimeout(()=>$("toast").classList.remove("show"), 2400);
}
function setStatus(ok, text, sub){
  $("dot").style.background = ok ? "var(--good)" : "var(--bad)";
  $("dot").style.boxShadow = ok ? "0 0 0 6px rgba(68,208,123,.12)" : "0 0 0 6px rgba(255,91,107,.12)";
  $("statusText").textContent = text;
  $("statusSub").textContent = sub || "";
  $("footState").textContent = ok ? "conectado ‚úÖ" : "error ‚ùå";
  $("footBucket").textContent = "bucket: " + BUCKET;
}
function slugify(s){
  return (s||"").toString().trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/(^-|-$)/g,"")
    .slice(0,60);
}
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
function escapeAttr(s){ return (s||"").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

async function withTimeout(p, ms=9000){
  let t;
  const timeout = new Promise((_,rej)=> t=setTimeout(()=>rej(new Error("Timeout")), ms));
  try { return await Promise.race([p, timeout]); }
  finally { clearTimeout(t); }
}

/* ========= CARGA LIBRER√çA (con fallback) ========= */
function loadScript(src){
  return new Promise((resolve, reject)=>{
    const s = document.createElement("script");
    s.src = src;
    s.async = true;
    s.onload = ()=>resolve(src);
    s.onerror = ()=>reject(new Error("No carg√≥: " + src));
    document.head.appendChild(s);
  });
}

async function ensureSupabaseLoaded(){
  if(window.supabase && window.supabase.createClient) return "ya estaba";
  const cdns = [
    "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",
    "https://unpkg.com/@supabase/supabase-js@2",
    "https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/umd/supabase.min.js"
  ];
  let lastErr = null;
  for(const url of cdns){
    try{
      $("statusSub").textContent = "cargando librer√≠a‚Ä¶";
      await withTimeout(loadScript(url), 12000);
      if(window.supabase && window.supabase.createClient) return url;
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("No pude cargar supabase-js");
}

/* ========= APP ========= */
let supabase = null;

async function checkConnection(){
  try{
    const { error } = await withTimeout(
      supabase.from("expos").select("id").limit(1),
      9000
    );
    if(error) throw error;
    setStatus(true, "Conectado ‚úÖ", "DB OK");
    return true;
  }catch(e){
    setStatus(false, "No conecta ‚ùå", e?.message || "error");
    return false;
  }
}

/* ========= TABS ========= */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const name = t.dataset.tab;
    $("panel-expos").style.display = (name==="expos") ? "" : "none";
    $("panel-subir").style.display = (name==="subir") ? "" : "none";
    $("panel-galeria").style.display = (name==="galeria") ? "" : "none";
  });
});

/* ========= EXPO ========= */
$("expoTitle").addEventListener("input", ()=>{
  $("expoSlug").value = slugify($("expoTitle").value);
});

function updateExpoLink(){
  const sel = $("expoSelect");
  const opt = sel.options[sel.selectedIndex];
  const slug = opt ? opt.getAttribute("data-slug") : "";
  if(!sel.value || !slug){ $("expoLink").value = ""; return; }
  const url = new URL(window.location.href);
  url.searchParams.set("expo", slug);
  $("expoLink").value = url.toString();
}

async function refreshExpos(){
  const { data, error } = await supabase
    .from("expos")
    .select("id,title,slug,created_at")
    .order("created_at", { ascending:false });
  if(error){ toast("Error expos ‚ùå", error.message); return; }

  const sel = $("expoSelect");
  sel.innerHTML = `<option value="">‚Äî Eleg√≠ una expo ‚Äî</option>` +
    (data||[]).map(r=>`<option value="${r.id}" data-slug="${r.slug}">${escapeHtml(r.title)} (${escapeHtml(r.slug)})</option>`).join("");

  // si viene por link ?expo=
  const url = new URL(window.location.href);
  const qslug = url.searchParams.get("expo");
  if(qslug){
    const found = (data||[]).find(x=>x.slug===qslug);
    if(found) sel.value = found.id;
  }

  updateExpoLink();
}

$("expoSelect").addEventListener("change", updateExpoLink);

$("btnCopyLink").addEventListener("click", async ()=>{
  const v = $("expoLink").value;
  if(!v){ toast("Eleg√≠ una expo"); return; }
  try{ await navigator.clipboard.writeText(v); toast("Copiado ‚úÖ"); }
  catch{ toast("No pude copiar ‚ùå", "Copialo a mano manteniendo apretado"); }
});

$("btnRefreshExpos").addEventListener("click", refreshExpos);

$("btnCreateExpo").addEventListener("click", async ()=>{
  const title = $("expoTitle").value.trim();
  const slug = slugify(title);
  if(!title){ toast("Pon√© un nombre"); return; }
  const { error } = await supabase.from("expos").insert({ title, slug });
  if(error){ toast("No cre√≥ ‚ùå", error.message); return; }
  toast("Expo creada ‚úÖ", slug);
  $("expoTitle").value=""; $("expoSlug").value="";
  await refreshExpos();
});

/* ========= UPLOAD + DB ========= */
$("btnGoGallery").addEventListener("click", ()=>document.querySelector(`.tab[data-tab="galeria"]`).click());

$("btnUpload").addEventListener("click", async ()=>{
  const expoId = $("expoSelect").value;
  const expoSlug = $("expoSelect").options[$("expoSelect").selectedIndex]?.getAttribute("data-slug") || "";
  if(!expoId || !expoSlug){ toast("Eleg√≠ una expo primero"); return; }

  const file = $("file").files && $("file").files[0];
  if(!file){ toast("Eleg√≠ una foto"); return; }

  const title = $("drawTitle").value.trim() || "Dibujo";
  const ext = (file.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g,"") || "jpg";
  const path = `${expoSlug}/${Date.now()}-${Math.random().toString(16).slice(2)}.${ext}`;

  $("btnUpload").setAttribute("disabled","disabled");
  try{
    const up = await supabase.storage.from(BUCKET).upload(path, file, { upsert:false, contentType:file.type || undefined });
    if(up.error) throw up.error;

    const pub = supabase.storage.from(BUCKET).getPublicUrl(path);
    const publicUrl = pub?.data?.publicUrl;
    if(!publicUrl) throw new Error("No pude obtener publicUrl");

    const insDraw = await supabase.from("drawings").insert({ title, image_url: publicUrl }).select("id").single();
    if(insDraw.error) throw insDraw.error;

    const insItem = await supabase.from("expo_items").insert({ expo_id: expoId, drawing_id: insDraw.data.id });
    if(insItem.error) throw insItem.error;

    toast("Subi√≥ ‚úÖ", "Ya deber√≠a verse en galer√≠a");
    $("file").value=""; $("drawTitle").value="";
  }catch(e){
    toast("Error ‚ùå", e?.message || "fall√≥");
  }finally{
    $("btnUpload").removeAttribute("disabled");
  }
});

/* ========= GALERIA ========= */
async function loadGallery(){
  const expoId = $("expoSelect").value;
  if(!expoId){ toast("Eleg√≠ una expo"); return; }

  const grid = $("galleryGrid");
  grid.innerHTML = "";

  const { data, error } = await supabase
    .from("expo_items")
    .select("id, created_at, drawings ( id, title, image_url, created_at )")
    .eq("expo_id", expoId)
    .order("created_at", { ascending:false });

  if(error){ toast("Error galer√≠a ‚ùå", error.message); return; }

  const rows = (data||[]).map(x=>x.drawings).filter(Boolean);
  if(rows.length===0){ grid.innerHTML = `<div class="hint">No hay dibujos todav√≠a.</div>`; return; }

  grid.innerHTML = rows.map(r=>{
    const t = escapeHtml(r.title || "Dibujo");
    const u = escapeAttr(r.image_url || "");
    return `
      <div class="imgcard" data-title="${escapeAttr(t)}" data-url="${u}">
        <img src="${u}" alt="${t}" loading="lazy"/>
        <div class="meta">
          <b>${t}</b>
          <small>${new Date(r.created_at || Date.now()).toLocaleString()}</small>
        </div>
      </div>
    `;
  }).join("");

  document.querySelectorAll(".imgcard").forEach(c=>{
    c.addEventListener("click", ()=>{
      $("modalTitle").textContent = c.getAttribute("data-title") || "Dibujo";
      $("modalImg").src = c.getAttribute("data-url") || "";
      $("modal").classList.add("open");
    });
  });
}
$("btnLoadGallery").addEventListener("click", loadGallery);

/* ========= MODAL ========= */
$("modalClose").addEventListener("click", ()=> $("modal").classList.remove("open"));
$("modal").addEventListener("click", (e)=>{ if(e.target === $("modal")) $("modal").classList.remove("open"); });

/* ========= BOOT ========= */
async function boot(){
  try{
    setStatus(false, "Conectando‚Ä¶", "cargando librer√≠a");
    const used = await ensureSupabaseLoaded();

    // crear client reci√©n despu√©s de cargar librer√≠a
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    setStatus(false, "Conectando‚Ä¶", "probando Supabase");
    const ok = await checkConnection();
    if(ok){
      await refreshExpos();
      const url = new URL(window.location.href);
      if(url.searchParams.get("expo")){
        document.querySelector(`.tab[data-tab="galeria"]`).click();
        await loadGallery();
      }
    }else{
      toast("No conecta a DB ‚ùå", "Pero la web ya est√° viva (JS carg√≥).");
    }

  }catch(e){
    // ESTE ES EL PUNTO: si el CDN muere, ahora lo ves y no queda clavado
    setStatus(false, "JS no carg√≥ ‚ùå", e?.message || "error");
    toast("Bloqueado por CDN ‚ùå", "Prob√° recargar o modo privado (te digo abajo).");
  }
}

$("btnRetry").addEventListener("click", boot);
boot();
</script>
</body>
</html>