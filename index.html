<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Martu-art ¬∑ Expos + Dibujos</title>
  <style>
    :root{
      --bg1:#071018;
      --bg2:#0b1420;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:#e8ecf6;
      --muted:rgba(232,236,246,.62);
      --good:#44d07b;
      --bad:#ff5b6b;
      --brand:#7aa2ff;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:22px;
      --press: translateY(1px) scale(.99);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 20% -10%, rgba(122,162,255,.28), transparent 60%),
        radial-gradient(900px 520px at 120% 10%, rgba(68,208,123,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 90px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;border:1px solid var(--stroke);border-radius:var(--r);
      background:rgba(255,255,255,.05); box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{
      width:46px;height:46px;border-radius:16px;
      background:linear-gradient(145deg, rgba(122,162,255,.85), rgba(122,162,255,.20));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 24px rgba(0,0,0,.35) inset;
      flex:0 0 auto;
    }
    .bt{min-width:0}
    h1{font-size:28px;line-height:1.05;margin:0}
    .sub{margin-top:4px;color:var(--muted);font-weight:600}
    .statusPill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      font-weight:800;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--bad);box-shadow:0 0 0 6px rgba(255,91,107,.14)}
    .dot.ok{background:var(--good);box-shadow:0 0 0 6px rgba(68,208,123,.14)}
    .tabs{
      margin-top:14px;
      display:flex;gap:10px;
      padding:10px;border:1px solid var(--stroke);border-radius:var(--r);
      background:rgba(255,255,255,.04);
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      overflow:auto;
    }
    .tab{
      flex:1 0 auto;
      display:flex;align-items:center;justify-content:center;gap:10px;
      padding:14px 14px;border-radius:18px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .tab:active{transform:var(--press)}
    .tab.on{background:rgba(122,162,255,.16);border-color:rgba(122,162,255,.35)}
    .panel{
      margin-top:12px;
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background:rgba(255,255,255,.04);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .hint{color:var(--muted);font-weight:650;margin:0 0 12px}
    label{display:block;color:var(--muted);font-weight:800;margin:12px 0 8px}
    input,select{
      width:100%;
      background:rgba(0,0,0,.22);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px 14px;
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:14px 16px;border-radius:18px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn.primary{background:rgba(122,162,255,.18);border-color:rgba(122,162,255,.38)}
    .btn:active{transform:var(--press)}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width:740px){ .grid{grid-template-columns:1fr} }
    .tile{
      border:1px solid var(--stroke);
      border-radius:18px;
      background:rgba(0,0,0,.20);
      padding:12px;
      overflow:hidden;
    }
    .thumb{
      width:100%;
      aspect-ratio: 4/3;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      object-fit:cover;
      display:block;
    }
    .tTitle{margin:10px 0 0;font-weight:900}
    .tMeta{margin:4px 0 0;color:var(--muted);font-weight:700;font-size:13px}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      max-width:min(560px, calc(100vw - 24px));
      padding:12px 14px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      box-shadow:0 16px 44px rgba(0,0,0,.55);
      display:none;
      font-weight:900;
    }
    .toast.show{display:block}
    .toast.ok{border-color:rgba(68,208,123,.35)}
    .toast.bad{border-color:rgba(255,91,107,.35)}
    .smallBar{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;justify-content:space-between;
      color:var(--muted);font-weight:800;font-size:13px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="bt">
          <h1>Martu-art</h1>
          <div class="sub">Expos + Dibujos (GitHub Pages + Supabase)</div>
        </div>
      </div>

      <div class="statusPill" id="pill">
        <span class="dot" id="dot"></span>
        <span id="statusText">Conectando‚Ä¶</span>
        <span id="statusMark" style="opacity:.9"></span>
      </div>
    </div>

    <div class="tabs">
      <div class="tab on" id="tExpos">üìÅ Expos</div>
      <div class="tab" id="tUpload">‚¨ÜÔ∏è Subir dibujo</div>
      <div class="tab" id="tGallery">üñºÔ∏è Galer√≠a</div>
    </div>

    <!-- EXPO -->
    <div class="panel" id="pExpos">
      <p class="hint">Cre√° una expo (se autogenera el slug). Despu√©s pod√©s compartir el link.</p>

      <label>Nombre de la expo</label>
      <input id="expoName" placeholder="Ej: Primavera 2026, Dinosaurios, etc."/>

      <label>Slug (se autogenera)</label>
      <input id="expoSlug" placeholder="ej: primavera-2026" disabled/>

      <div class="row" style="margin-top:12px">
        <div class="btn primary" id="btnCreateExpo">Crear expo</div>
        <div class="btn" id="btnRefreshExpos">Actualizar lista</div>
      </div>

      <div class="sep"></div>

      <label>Expo seleccionada</label>
      <select id="expoSelect">
        <option value="">‚Äî Eleg√≠ una expo ‚Äî</option>
      </select>

      <label>Link de la expo (para compartir)</label>
      <input id="shareLink" readonly placeholder="Se completa al elegir una expo"/>

      <div class="row" style="margin-top:12px">
        <div class="btn" id="btnCopy">Copiar link</div>
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div class="tile">
          <div class="tTitle" id="statExpos">0</div>
          <div class="tMeta">Expos creadas</div>
        </div>
        <div class="tile">
          <div class="tTitle" id="statDrawings">0</div>
          <div class="tMeta">Dibujos en esta expo</div>
        </div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div class="panel" id="pUpload" style="display:none">
      <p class="hint">Sub√≠ una foto del dibujo (jpg/png). Se guarda en el bucket y queda en la expo seleccionada.</p>

      <label>Archivo (foto del dibujo)</label>
      <input type="file" id="file" accept="image/*"/>

      <label>T√≠tulo (opcional)</label>
      <input id="drawTitle" placeholder="Ej: Gatito, Arcoiris, etc."/>

      <div class="row" style="margin-top:12px">
        <div class="btn primary" id="btnUpload">Subir</div>
        <div class="btn" id="btnGoGallery">Ver galer√≠a</div>
      </div>

      <div class="smallBar">
        <span>Modo: <span class="mono">P√∫blico (sin login)</span></span>
        <span>bucket: <span class="mono" id="bucketName">‚Äî</span></span>
      </div>
    </div>

    <!-- GALLERY -->
    <div class="panel" id="pGallery" style="display:none">
      <p class="hint">Galer√≠a de la expo seleccionada.</p>
      <div class="row" style="margin-bottom:10px">
        <div class="btn" id="btnReloadGallery">Actualizar galer√≠a</div>
      </div>
      <div class="grid" id="galleryGrid"></div>
      <div id="galleryEmpty" style="color:var(--muted);font-weight:800;margin-top:10px;display:none">
        No hay dibujos todav√≠a en esta expo.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /******************************
     * CONFIG (YA QUEDA ‚ÄúFIJO‚Äù)
     ******************************/
    const SUPABASE_URL = "https://vfvbssenzfbrnkydddxo.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable__3wLx8HB6dbL49gWL9Eyfw_kJPFh6kS";
    const BUCKET = "drawings"; // tu bucket

    /******************************
     * HELPERS
     ******************************/
    const $ = (id)=>document.getElementById(id);

    const toastEl = $("toast");
    function toast(msg, type=""){
      toastEl.className = "toast show" + (type ? (" " + type) : "");
      toastEl.textContent = msg;
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=>toastEl.classList.remove("show"), 2200);
    }

    function slugify(s){
      return (s||"")
        .toLowerCase()
        .trim()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9]+/g,"-")
        .replace(/(^-|-$)/g,"");
    }

    function headersJSON(){
      return {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json"
      };
    }
    function headersAuth(extra={}){
      return Object.assign({
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": "Bearer " + SUPABASE_ANON_KEY
      }, extra);
    }

    function publicObjectUrl(path){
      return `${SUPABASE_URL}/storage/v1/object/public/${encodeURIComponent(BUCKET)}/${path.split("/").map(encodeURIComponent).join("/")}`;
    }

    function setConnected(ok, msg){
      const dot = $("dot");
      const st = $("statusText");
      const mark = $("statusMark");
      const pill = $("pill");
      if(ok){
        dot.classList.add("ok");
        st.textContent = msg || "Conectado";
        mark.textContent = "‚úÖ";
        pill.style.borderColor = "rgba(68,208,123,.35)";
      }else{
        dot.classList.remove("ok");
        st.textContent = msg || "Error";
        mark.textContent = "‚ùå";
        pill.style.borderColor = "rgba(255,91,107,.35)";
      }
    }

    /******************************
     * API (PostgREST)
     ******************************/
    async function dbSelect(table, query){
      const url = `${SUPABASE_URL}/rest/v1/${table}?${query}`;
      const r = await fetch(url, { headers: headersAuth() });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`DB ${table} ${r.status}: ${t || r.statusText}`);
      }
      return r.json();
    }

    async function dbInsert(table, rows){
      const url = `${SUPABASE_URL}/rest/v1/${table}`;
      const r = await fetch(url, {
        method:"POST",
        headers: headersJSON(),
        body: JSON.stringify(rows)
      });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`DB insert ${table} ${r.status}: ${t || r.statusText}`);
      }
      // si no pedimos return=representation, puede venir vac√≠o y est√° ok
      const txt = await r.text().catch(()=> "");
      return txt ? JSON.parse(txt) : [];
    }

    /******************************
     * STORAGE (upload)
     ******************************/
    async function storageUpload(path, file){
      const url = `${SUPABASE_URL}/storage/v1/object/${encodeURIComponent(BUCKET)}/${path.split("/").map(encodeURIComponent).join("/")}`;
      const r = await fetch(url, {
        method:"PUT",
        headers: headersAuth({
          "Content-Type": file.type || "application/octet-stream",
          "x-upsert": "true"
        }),
        body: file
      });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`Storage upload ${r.status}: ${t || r.statusText}`);
      }
      return true;
    }

    /******************************
     * APP STATE
     ******************************/
    $("bucketName").textContent = BUCKET;

    let expos = [];
    let selectedExpo = "";
    let selectedExpoSlug = "";

    function setTabs(on){
      $("tExpos").classList.toggle("on", on==="expos");
      $("tUpload").classList.toggle("on", on==="upload");
      $("tGallery").classList.toggle("on", on==="gallery");
      $("pExpos").style.display = (on==="expos") ? "" : "none";
      $("pUpload").style.display = (on==="upload") ? "" : "none";
      $("pGallery").style.display = (on==="gallery") ? "" : "none";
    }

    $("tExpos").onclick = ()=>setTabs("expos");
    $("tUpload").onclick = ()=>setTabs("upload");
    $("tGallery").onclick = ()=>{ setTabs("gallery"); reloadGallery(); };

    $("expoName").addEventListener("input", (e)=>{
      $("expoSlug").value = slugify(e.target.value);
    });

    async function connectAndBoot(){
      try{
        // ‚Äúping‚Äù DB: traigo 1 expo (o 0) para verificar conexi√≥n
        await dbSelect("expos", "select=id&limit=1");
        setConnected(true, "Conectado");
        await refreshExpos();
      }catch(err){
        console.log(err);
        setConnected(false, "No conecta");
        toast("No conecta con Supabase ‚ùå", "bad");
      }
    }

    async function refreshExpos(){
      try{
        const rows = await dbSelect("expos", "select=id,title,slug,created_at&order=created_at.desc");
        expos = rows || [];
        $("statExpos").textContent = String(expos.length);

        const sel = $("expoSelect");
        const prev = sel.value;
        sel.innerHTML = `<option value="">‚Äî Eleg√≠ una expo ‚Äî</option>` +
          expos.map(x=>`<option value="${x.id}">${escapeHtml(x.title)} (${escapeHtml(x.slug)})</option>`).join("");

        // re-selecciono si estaba
        if(prev){
          sel.value = prev;
        }
        // si no hay selecci√≥n y hay una expo, no selecciono sola (para no marear)
        if(sel.value){
          onExpoSelected(sel.value);
        }else{
          selectedExpo = "";
          selectedExpoSlug = "";
          $("shareLink").value = "";
          $("statDrawings").textContent = "0";
        }

        toast("Lista actualizada ‚úÖ", "ok");
      }catch(err){
        console.log(err);
        toast("Error actualizando expos ‚ùå", "bad");
      }
    }

    function buildShareLink(slug){
      const base = location.origin + location.pathname;
      return `${base}?expo=${encodeURIComponent(slug)}`;
    }

    async function onExpoSelected(expoId){
      selectedExpo = expoId;
      const e = expos.find(x=>x.id===expoId);
      selectedExpoSlug = e ? e.slug : "";
      $("shareLink").value = selectedExpoSlug ? buildShareLink(selectedExpoSlug) : "";

      // contar dibujos de la expo (expo_items)
      try{
        if(!selectedExpo){
          $("statDrawings").textContent = "0";
          return;
        }
        const rows = await dbSelect("expo_items", `select=id&expo_id=eq.${encodeURIComponent(selectedExpo)}&limit=2000`);
        $("statDrawings").textContent = String((rows||[]).length);
      }catch(err){
        console.log(err);
        $("statDrawings").textContent = "‚Äî";
      }
    }

    $("expoSelect").addEventListener("change", (e)=>onExpoSelected(e.target.value));

    $("btnRefreshExpos").onclick = refreshExpos;

    $("btnCopy").onclick = async ()=>{
      const v = $("shareLink").value.trim();
      if(!v){ toast("Primero eleg√≠ una expo", "bad"); return; }
      try{
        await navigator.clipboard.writeText(v);
        toast("Link copiado ‚úÖ", "ok");
      }catch{
        $("shareLink").focus();
        $("shareLink").select();
        toast("Copialo manual (seleccionado)", "ok");
      }
    };

    $("btnCreateExpo").onclick = async ()=>{
      const title = $("expoName").value.trim();
      if(!title){ toast("Pon√© el nombre de la expo", "bad"); return; }
      const slug = slugify(title);
      if(!slug){ toast("Nombre inv√°lido", "bad"); return; }

      try{
        // Insert expo
        await dbInsert("expos", [{ title, slug }]);
        $("expoName").value = "";
        $("expoSlug").value = "";
        toast("Expo creada ‚úÖ", "ok");
        await refreshExpos();
      }catch(err){
        console.log(err);
        toast("No pudo crear expo ‚ùå", "bad");
      }
    };

    $("btnGoGallery").onclick = ()=>{ setTabs("gallery"); reloadGallery(); };

    $("btnReloadGallery").onclick = reloadGallery;

    async function reloadGallery(){
      const grid = $("galleryGrid");
      const empty = $("galleryEmpty");
      grid.innerHTML = "";
      empty.style.display = "none";

      if(!selectedExpo){
        empty.textContent = "Eleg√≠ una expo en la pesta√±a Expos.";
        empty.style.display = "";
        return;
      }

      try{
        // Traigo expo_items con join a drawings (por FK drawing_id)
        // Esto requiere que la relaci√≥n exista y que RLS permita SELECT.
        const rows = await dbSelect("expo_items", `select=id,created_at,drawings(id,title,image_url,created_at)&expo_id=eq.${encodeURIComponent(selectedExpo)}&order=created_at.desc&limit=200`);
        const items = (rows||[]).map(r=>r.drawings).filter(Boolean);

        $("statDrawings").textContent = String(items.length);

        if(items.length===0){
          empty.textContent = "No hay dibujos todav√≠a en esta expo.";
          empty.style.display = "";
          return;
        }

        for(const d of items){
          const tile = document.createElement("div");
          tile.className = "tile";
          const img = document.createElement("img");
          img.className = "thumb";
          img.src = d.image_url || "";
          img.alt = d.title || "Dibujo";
          img.loading = "lazy";

          const t = document.createElement("div");
          t.className = "tTitle";
          t.textContent = d.title || "Sin t√≠tulo";

          const m = document.createElement("div");
          m.className = "tMeta";
          m.textContent = d.created_at ? new Date(d.created_at).toLocaleString() : "";

          tile.appendChild(img);
          tile.appendChild(t);
          tile.appendChild(m);
          grid.appendChild(tile);
        }
      }catch(err){
        console.log(err);
        toast("Error cargando galer√≠a ‚ùå", "bad");
      }
    }

    $("btnUpload").onclick = async ()=>{
      const f = $("file").files && $("file").files[0];
      if(!selectedExpo){ toast("Primero eleg√≠ una expo", "bad"); setTabs("expos"); return; }
      if(!f){ toast("Eleg√≠ una imagen", "bad"); return; }

      const title = $("drawTitle").value.trim();
      const ext = (f.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g,"");
      const safeExt = ext || "jpg";
      const fileName = `${Date.now()}-${Math.random().toString(16).slice(2)}.${safeExt}`;
      const filePath = `${selectedExpoSlug || selectedExpo}/${fileName}`;

      try{
        toast("Subiendo‚Ä¶", "");
        await storageUpload(filePath, f);

        const image_url = publicObjectUrl(filePath);

        // Guardar en drawings + link con expo_items
        // NOTA: requiere RLS (SELECT/INSERT) para anon en tablas expos/drawings/expo_items
        const dRows = await dbInsert("drawings", [{ title: title || null, image_url }]);

        // Si Supabase no devuelve filas, busco el √∫ltimo por image_url
        let drawingId = (dRows && dRows[0] && dRows[0].id) ? dRows[0].id : null;
        if(!drawingId){
          const q = `select=id&image_url=eq.${encodeURIComponent(image_url)}&order=created_at.desc&limit=1`;
          const found = await dbSelect("drawings", q);
          drawingId = found && found[0] && found[0].id ? found[0].id : null;
        }

        if(!drawingId){
          throw new Error("No pude obtener el id del dibujo en DB");
        }

        await dbInsert("expo_items", [{ expo_id: selectedExpo, drawing_id: drawingId }]);

        toast("Subido ‚úÖ", "ok");
        $("drawTitle").value = "";
        $("file").value = "";
        await onExpoSelected(selectedExpo);
      }catch(err){
        console.log(err);
        toast("No subi√≥ ‚ùå", "bad");
      }
    };

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // Si viene ?expo=slug, intento seleccionarla
    async function trySelectFromUrl(){
      const p = new URLSearchParams(location.search);
      const slug = (p.get("expo")||"").trim();
      if(!slug) return;
      // Espero a cargar expos y selecciono
      const e = expos.find(x=>x.slug===slug);
      if(e){
        $("expoSelect").value = e.id;
        await onExpoSelected(e.id);
        setTabs("gallery");
        await reloadGallery();
      }
    }

    // Boot
    (async ()=>{
      $("bucketName").textContent = BUCKET;
      await connectAndBoot();
      await trySelectFromUrl();
    })();
  </script>
</body>
</html>