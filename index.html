<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Martu-art ¬∑ Expos + Dibujos</title>
  <style>
    :root{
      --bg:#0f1115;
      --stroke:rgba(255,255,255,.10);
      --text:#e8ecf6;
      --muted:rgba(232,236,246,.62);
      --brand:#7aa2ff;
      --good:#44d07b;
      --bad:#ff5b6b;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --r:22px;
      --press: translateY(1px) scale(.99);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(122,162,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 100% 0%, rgba(68,208,123,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 90px}
    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .top{
      display:flex; gap:14px; align-items:center;
      padding:14px;
    }
    .logo{
      width:70px;height:70px;border-radius:18px;
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(122,162,255,.20));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
    }
    .title{font-size:34px; font-weight:900; letter-spacing:.2px; line-height:1.05}
    .subtitle{margin-top:6px; color:var(--muted); font-weight:650}
    .status{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      min-width: 260px;
      justify-content:flex-start;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .status b{font-size:18px}
    .status small{display:block;color:var(--muted); margin-top:2px}
    .dot.good{background:var(--good); box-shadow: 0 0 0 6px rgba(68,208,123,.12)}
    .dot.bad{background:var(--bad); box-shadow: 0 0 0 6px rgba(255,91,107,.12)}
    .tabs{
      display:flex; gap:12px; padding:0 14px 14px;
    }
    .tab{
      flex:1;
      display:flex; gap:10px; align-items:center; justify-content:center;
      padding:14px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight:900;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tab:active{transform: var(--press)}
    .tab.active{
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.35);
    }

    .panel{display:none; padding:14px}
    .panel.active{display:block}

    .muted{color:var(--muted)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media(max-width:760px){ .grid2{grid-template-columns:1fr} .status{min-width: 0} }
    label{display:block; margin:12px 0 8px; font-weight:900}
    input, select{
      width:100%;
      border-radius:16px;
      padding:14px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    input::placeholder{color:rgba(232,236,246,.40)}
    .btnRow{display:flex; gap:12px; margin-top:12px; flex-wrap:wrap}
    .btn{
      padding:14px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: var(--press)}
    .btn.primary{
      background: rgba(122,162,255,.22);
      border-color: rgba(122,162,255,.35);
    }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .kpi .box{
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:12px 12px;
    }
    .kpi .n{font-size:28px; font-weight:1000}
    .kpi .t{color:var(--muted); font-weight:800}

    .galleryGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media(max-width:900px){ .galleryGrid{grid-template-columns: repeat(3, 1fr);} }
    @media(max-width:650px){ .galleryGrid{grid-template-columns: repeat(2, 1fr);} }
    .thumb{
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      aspect-ratio: 1 / 1;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .thumb img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb:active{transform: var(--press)}
    .pill{
      position:absolute;
      left:10px; top:10px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      color: rgba(232,236,246,.85);
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      backdrop-filter: blur(8px);
    }

    .footer{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 14px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(15,17,21,.92), rgba(15,17,21,.65), transparent);
      color: rgba(232,236,246,.85);
      font-weight:800;
      display:flex; justify-content:space-between; gap:12px;
      font-size:14px;
    }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:72px;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      padding:12px 14px;
      display:none;
      align-items:center;
      gap:10px;
      backdrop-filter: blur(10px);
      max-width:min(520px, calc(100% - 24px));
      z-index:20;
    }
    .toast.show{display:flex}
    .toast .x{
      margin-left:auto;
      opacity:.75;
      cursor:pointer;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .toast .x:active{transform: var(--press)}

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.78);
      display:none;
      z-index:30;
      padding:14px;
    }
    .modal.show{display:flex}
    .modalInner{
      margin:auto;
      width:min(980px, 100%);
      height:min(90vh, 900px);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(10px);
    }
    .modalImg{
      width:100%; height:100%;
      object-fit:contain;
      background: rgba(0,0,0,.25);
    }
    .modalHint{
      position:absolute; left:12px; top:12px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      color: rgba(232,236,246,.85);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
    }
    .modalClose{
      position:absolute; right:12px; top:12px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      color: rgba(232,236,246,.9);
      padding:10px 12px;
      border-radius:999px;
      font-weight:1000;
      cursor:pointer;
    }
    .modalClose:active{transform: var(--press)}
    .sep{height:1px;background:rgba(255,255,255,.10); margin:12px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">Martu-art</div>
        <div class="subtitle">Expos + Dibujos (GitHub Pages + Supabase Storage)</div>
      </div>

      <div class="status" id="statusPill">
        <span class="dot bad" id="dot"></span>
        <div>
          <b id="stTitle">Conectando‚Ä¶</b>
          <small id="stSub" class="muted">probando Storage</small>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabExpos">üìÅ Expos</div>
      <div class="tab" id="tabUpload">‚¨ÜÔ∏è Subir dibujo</div>
      <div class="tab" id="tabGallery">üñºÔ∏è Galer√≠a</div>
    </div>

    <div class="panel active" id="panelExpos">
      <div class="muted">
        Esto usa <b>solo Storage</b> (sin DB y sin librer√≠as externas). Menos magia, m√°s funciona.
      </div>

      <label>Nombre de la expo</label>
      <input id="expoName" placeholder="Ej: Primavera 2026, Dinosaurios, etc."/>

      <label>Slug (se autogenera)</label>
      <input id="expoSlug" placeholder="ej: primavera-2026" disabled/>

      <div class="btnRow">
        <button class="btn primary" id="btnCreateExpo">Crear expo</button>
        <button class="btn" id="btnRefresh">Actualizar lista</button>
      </div>

      <div class="sep"></div>

      <label>Expo seleccionada</label>
      <select id="expoSelect">
        <option value="">‚Äî Eleg√≠ una expo ‚Äî</option>
      </select>

      <label>Link de la expo (para compartir)</label>
      <input id="expoLink" placeholder="Se completa al elegir una expo" readonly/>
      <div class="btnRow">
        <button class="btn" id="btnCopyLink">Copiar link</button>
      </div>

      <div class="kpi">
        <div class="box">
          <div class="n" id="kpiExpos">0</div>
          <div class="t">Expos creadas</div>
        </div>
        <div class="box">
          <div class="n" id="kpiFiles">0</div>
          <div class="t">Dibujos en esta expo</div>
        </div>
      </div>
    </div>

    <div class="panel" id="panelUpload">
      <div class="muted">
        Sub√≠ una foto del dibujo (jpg/png). Se guarda en el bucket y queda en la expo seleccionada.
      </div>

      <label>Expo</label>
      <select id="uploadExpoSelect">
        <option value="">‚Äî Eleg√≠ una expo ‚Äî</option>
      </select>

      <label>Archivo (foto del dibujo)</label>
      <input type="file" id="fileInput" accept="image/*"/>

      <label>T√≠tulo (opcional)</label>
      <input id="titleInput" placeholder="Ej: Gatito, Arcoiris, etc."/>

      <div class="btnRow">
        <button class="btn primary" id="btnUpload">Subir</button>
        <button class="btn" id="btnGoGallery">Ver galer√≠a</button>
      </div>
    </div>

    <div class="panel" id="panelGallery">
      <div class="muted">
        Eleg√≠ una expo y te muestro los dibujos subidos.
      </div>

      <label>Expo</label>
      <select id="galleryExpoSelect">
        <option value="">‚Äî Eleg√≠ una expo ‚Äî</option>
      </select>

      <div class="btnRow">
        <button class="btn" id="btnLoadGallery">Cargar galer√≠a</button>
      </div>

      <div class="sep"></div>
      <div class="galleryGrid" id="galleryGrid"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div id="toastMsg">‚Äî</div>
  <div class="x" id="toastX">√ó</div>
</div>

<div class="modal" id="modal">
  <div class="modalInner">
    <div class="modalHint">Toc√° para agrandar</div>
    <button class="modalClose" id="modalClose">Cerrar</button>
    <img id="modalImg" class="modalImg" alt="Dibujo"/>
  </div>
</div>

<div class="footer">
  <div>Estado: <b id="footState">‚Äî</b></div>
  <div>bucket: <b id="footBucket">‚Äî</b></div>
</div>

<script>
/* ============================================================
   1) CONFIG (TOC√Å SOLO ESTO)
   ============================================================ */
// üëá Peg√° ac√° tu Project URL
const SUPABASE_URL = "https://vfvbssenzfbrnkydddxo.supabase.co";

// üëá Tu publishable key
const SUPABASE_KEY = "sb_publishable__3wLx8HB6dbL49gWL9Eyfw_kJPFh6kS";

const BUCKET = "drawings";

/* ============================================================
   2) UI helpers
   ============================================================ */
const $ = (id)=>document.getElementById(id);

const toast = (msg, bad=false)=>{
  $("toastMsg").textContent = msg;
  $("toastMsg").style.color = bad ? "var(--bad)" : "rgba(232,236,246,.92)";
  $("toast").classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> $("toast").classList.remove("show"), 2600);
};
$("toastX").onclick = ()=> $("toast").classList.remove("show");

const setStatus = (ok, title, sub="")=>{
  $("dot").className = "dot " + (ok ? "good" : "bad");
  $("stTitle").textContent = title;
  $("stSub").textContent = sub;
  $("footState").textContent = ok ? "ok" : "error";
  $("footBucket").textContent = BUCKET;
};

function slugify(s){
  return (s||"")
    .trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-+|-+$/g,"")
    .slice(0,60);
}

function expoShareLink(slug){
  const u = new URL(location.href);
  u.searchParams.set("expo", slug);
  return u.toString();
}

function publicUrl(path){
  return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${encodeURI(path)}`;
}

/* ============================================================
   3) Supabase Storage REST (sin librer√≠as externas)
   ============================================================ */
const API = `${SUPABASE_URL}/storage/v1`;

async function sbFetch(path, opts={}){
  const headers = new Headers(opts.headers || {});
  headers.set("apikey", SUPABASE_KEY);
  headers.set("Authorization", `Bearer ${SUPABASE_KEY}`);
  // algunos endpoints andan mejor con este
  headers.set("x-client-info", "martu-art-storage-only");
  if(opts.json){
    headers.set("Content-Type","application/json");
    opts.body = JSON.stringify(opts.json);
    delete opts.json;
  }
  const res = await fetch(`${API}${path}`, { ...opts, headers });
  return res;
}

async function testStorage(){
  // endpoint liviano: lista 1 objeto (si hay permisos, responde 200/400 pero con JSON)
  const res = await sbFetch(`/object/list/${BUCKET}`, { method:"POST", json:{ prefix:"", limit:1, offset:0 } });
  const txt = await res.text();
  // 200 o 400 con JSON v√°lido: Storage responde; 0/failed: no lleg√≥
  if(!res.ok){
    // Si contesta JSON con error de policy, tambi√©n est√° ‚Äúvivo‚Äù (pero faltan permisos)
    try{ JSON.parse(txt); }catch(e){ throw new Error("No responde Storage (red/CORS/DNS)"); }
    // Si hay error de permisos, lo detectamos para decirlo claro
    if(txt.includes("new row violates row-level security") || txt.includes("row level security") || txt.includes("permission")){
      throw new Error("RLS: faltan policies en Storage");
    }
    // bucket inexistente
    if(txt.toLowerCase().includes("bucket") && txt.toLowerCase().includes("not found")){
      throw new Error("Bucket drawings no existe");
    }
    // otro error
    throw new Error("Storage respondi√≥ con error");
  }
  return true;
}

async function listAllObjects(prefix=""){
  const out = [];
  let offset = 0;
  const limit = 1000;
  while(true){
    const res = await sbFetch(`/object/list/${BUCKET}`, {
      method:"POST",
      json:{ prefix, limit, offset, sortBy:{ column:"name", order:"asc" } }
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error(data?.message || "No pude listar Storage");
    if(!Array.isArray(data)) break;
    out.push(...data);
    if(data.length < limit) break;
    offset += limit;
  }
  return out;
}

async function listExpos(){
  const objs = await listAllObjects("");
  const set = new Set();
  for(const o of objs){
    const name = o?.name || "";
    const p = name.split("/")[0];
    if(p) set.add(p);
  }
  return Array.from(set).sort((a,b)=>a.localeCompare(b));
}

async function ensureExpoFolder(slug){
  // ‚ÄúCarpeta‚Äù en Storage = subir un archivo marcador
  const path = `${slug}/.keep`;
  const body = new Blob([`keep:${Date.now()}`], {type:"text/plain"});
  const res = await sbFetch(`/object/${BUCKET}/${path}`, {
    method:"POST",
    headers: { "x-upsert":"true", "Content-Type":"text/plain" },
    body
  });
  const txt = await res.text();
  if(!res.ok){
    if(txt.includes("row-level security") || txt.includes("RLS") || txt.includes("violates")){
      throw new Error("RLS: no ten√©s permiso para crear expo (policy insert)");
    }
    throw new Error("No pude crear expo");
  }
  return true;
}

async function uploadImage(slug, file, title=""){
  const safeName = (file.name || `foto-${Date.now()}.jpg`).replace(/[^\w.\-]+/g,"_");
  const stamp = new Date().toISOString().replace(/[:.]/g,"-");
  const base = title ? slugify(title).slice(0,30) : "dibujo";
  const filename = `${base}-${stamp}-${safeName}`;
  const path = `${slug}/${filename}`;

  const res = await sbFetch(`/object/${BUCKET}/${path}`, {
    method:"POST",
    headers: { "x-upsert":"true", "Content-Type": file.type || "application/octet-stream" },
    body: file
  });
  const txt = await res.text();
  if(!res.ok){
    if(txt.includes("row-level security") || txt.includes("RLS") || txt.includes("violates")){
      throw new Error("RLS: no ten√©s permiso para subir (policy insert)");
    }
    throw new Error("No subi√≥");
  }
  return { path, url: publicUrl(path) };
}

async function listExpoImages(slug){
  const objs = await listAllObjects(`${slug}/`);
  const imgs = [];
  for(const o of objs){
    const name = o?.name || "";
    if(!name || name.endsWith("/.keep")) continue;
    if(!/\.(png|jpg|jpeg|webp|gif)$/i.test(name)) continue;
    imgs.push({ path:name, url: publicUrl(name) });
  }
  // m√°s nuevo primero (si el nombre tiene timestamp ISO, sirve)
  imgs.sort((a,b)=>b.path.localeCompare(a.path));
  return imgs;
}

/* ============================================================
   4) UI logic
   ============================================================ */
function showPanel(which){
  $("tabExpos").classList.toggle("active", which==="expos");
  $("tabUpload").classList.toggle("active", which==="upload");
  $("tabGallery").classList.toggle("active", which==="gallery");
  $("panelExpos").classList.toggle("active", which==="expos");
  $("panelUpload").classList.toggle("active", which==="upload");
  $("panelGallery").classList.toggle("active", which==="gallery");
}

$("tabExpos").onclick = ()=>showPanel("expos");
$("tabUpload").onclick = ()=>showPanel("upload");
$("tabGallery").onclick = ()=>showPanel("gallery");

$("expoName").addEventListener("input", ()=>{
  $("expoSlug").value = slugify($("expoName").value);
});

$("btnCopyLink").onclick = async ()=>{
  const v = $("expoLink").value.trim();
  if(!v) return toast("Eleg√≠ una expo primero", true);
  try{
    await navigator.clipboard.writeText(v);
    toast("Link copiado ‚úÖ");
  }catch{
    toast("No pude copiar (iPhone a veces se pone exquisito). Manten√© apretado y copi√°.", true);
  }
};

$("btnGoGallery").onclick = ()=>{
  showPanel("gallery");
  const v = $("uploadExpoSelect").value;
  if(v) $("galleryExpoSelect").value = v;
};

function fillSelect(sel, expos){
  const cur = sel.value;
  sel.innerHTML = `<option value="">‚Äî Eleg√≠ una expo ‚Äî</option>` +
    expos.map(e=>`<option value="${e}">${e} (${e})</option>`).join("");
  if(expos.includes(cur)) sel.value = cur;
}

async function refreshAll(){
  const expos = await listExpos();
  $("kpiExpos").textContent = String(expos.length);
  fillSelect($("expoSelect"), expos);
  fillSelect($("uploadExpoSelect"), expos);
  fillSelect($("galleryExpoSelect"), expos);
  return expos;
}

$("btnRefresh").onclick = async ()=>{
  try{
    await refreshAll();
    toast("Lista actualizada ‚úÖ");
  }catch(e){
    console.error(e);
    toast(String(e.message||e), true);
  }
};

$("expoSelect").addEventListener("change", async ()=>{
  const slug = $("expoSelect").value;
  if(!slug){
    $("expoLink").value = "";
    $("kpiFiles").textContent = "0";
    return;
  }
  $("expoLink").value = expoShareLink(slug);
  try{
    const imgs = await listExpoImages(slug);
    $("kpiFiles").textContent = String(imgs.length);
  }catch{
    $("kpiFiles").textContent = "‚Äî";
  }
});

$("btnCreateExpo").onclick = async ()=>{
  const name = $("expoName").value.trim();
  const slug = slugify(name);
  if(!name || !slug) return toast("Pon√© un nombre de expo", true);

  try{
    await ensureExpoFolder(slug);
    toast("Expo creada ‚úÖ");
    $("expoName").value = "";
    $("expoSlug").value = "";
    await refreshAll();
    $("expoSelect").value = slug;
    $("expoSelect").dispatchEvent(new Event("change"));
  }catch(e){
    console.error(e);
    toast(String(e.message||e), true);
  }
};

$("btnUpload").onclick = async ()=>{
  const slug = $("uploadExpoSelect").value;
  if(!slug) return toast("Eleg√≠ una expo", true);

  const f = $("fileInput").files?.[0];
  if(!f) return toast("Eleg√≠ una foto", true);

  try{
    await uploadImage(slug, f, $("titleInput").value.trim());
    toast("Subi√≥ ‚úÖ");
    $("fileInput").value = "";
    $("titleInput").value = "";
  }catch(e){
    console.error(e);
    toast(String(e.message||e), true);
  }
};

$("btnLoadGallery").onclick = async ()=>{
  const slug = $("galleryExpoSelect").value;
  if(!slug) return toast("Eleg√≠ una expo", true);

  try{
    const imgs = await listExpoImages(slug);
    const grid = $("galleryGrid");
    grid.innerHTML = "";
    if(!imgs.length){
      grid.innerHTML = `<div class="muted">No hay dibujos en esta expo todav√≠a.</div>`;
      return;
    }
    for(const it of imgs){
      const d = document.createElement("div");
      d.className = "thumb";
      d.innerHTML = `<span class="pill">${slug}</span><img loading="lazy" src="${it.url}" alt="Dibujo"/>`;
      d.onclick = ()=> openModal(it.url);
      grid.appendChild(d);
    }
    toast("Galer√≠a cargada ‚úÖ");
  }catch(e){
    console.error(e);
    toast(String(e.message||e), true);
  }
};

/* Modal */
function openModal(url){
  $("modalImg").src = url;
  $("modal").classList.add("show");
}
function closeModal(){
  $("modal").classList.remove("show");
  $("modalImg").src = "";
}
$("modalClose").onclick = closeModal;
$("modal").onclick = (e)=>{ if(e.target === $("modal")) closeModal(); };

/* ============================================================
   5) Boot
   ============================================================ */
(async function boot(){
  // Validaci√≥n b√°sica de config
  if(!SUPABASE_URL.includes("supabase.co") || !SUPABASE_KEY.startsWith("sb_")){
    setStatus(false, "Error", "Peg√° tu SUPABASE_URL y SUPABASE_KEY arriba");
    toast("Config incompleta", true);
    return;
  }

  try{
    await testStorage();
    setStatus(true, "Conectado ‚úÖ", "");
    await refreshAll();

    // Si viene ?expo=algo, preseleccionar
    const url = new URL(location.href);
    const expo = (url.searchParams.get("expo") || "").trim();
    if(expo){
      $("expoSelect").value = expo;
      $("uploadExpoSelect").value = expo;
      $("galleryExpoSelect").value = expo;
      $("expoSelect").dispatchEvent(new Event("change"));
      showPanel("gallery");
      $("btnLoadGallery").click();
    }
  }catch(e){
    console.error(e);
    const msg = String(e.message||e);

    if(msg.includes("RLS")){
      setStatus(false, "Error", "Faltan permisos (RLS) en Storage");
      toast("Faltan policies en Storage (SQL). Hac√© el paso A y listo.", true);
      return;
    }
    if(msg.includes("Bucket")){
      setStatus(false, "Error", "No existe el bucket drawings");
      toast("Cre√° el bucket drawings en Storage", true);
      return;
    }

    setStatus(false, "Error", "No pude hablar con Storage");
    toast("No pude hablar con Storage. Puede ser Wi-Fi/DNS/CORS. Prob√° con 4G para confirmar.", true);
  }
})();
</script>
</body>
</html>